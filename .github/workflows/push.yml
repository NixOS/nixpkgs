name: Push

on:
  pull_request:
    paths:
      - .github/workflows/push.yml
      # eval is tested via pr.yml
  push:
    # Keep this synced with ci/request-reviews/dev-branches.txt
    branches:
      - master
      - staging
      - release-*
      - staging-*
      - haskell-updates
      - python-updates

permissions: {}

jobs:
  prepare:
    runs-on: ubuntu-24.04-arm
    outputs:
      systems: ${{ steps.systems.outputs.systems }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          sparse-checkout: |
            ci/supportedSystems.json

      - name: Load supported systems
        id: systems
        run: |
          echo "systems=$(jq -c <ci/supportedSystems.json)" >> "$GITHUB_OUTPUT"

  eval:
    name: Eval
    needs: [prepare]
    uses: ./.github/workflows/eval.yml
    # Those are not actually used on push, but will throw an error if not set.
    permissions:
      # compare
      issues: write
      pull-requests: write
      statuses: write
    with:
      mergedSha: ${{ github.sha }}
      systems: ${{ needs.prepare.outputs.systems }}
