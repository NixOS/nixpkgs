name: Install Nix

description: 'Install and configure Nix and setup Cachix.'

inputs:
  cachix-name:
    description: "Name of the cache on cachix to use. Defaults to nixpkgs-gha. Can be set in forks to allow pushing."
    required: true
  cachix-token:
    description: "Cachix Auth Token to allow pushing."
    required: true

runs:
  using: composite
  steps:
    - uses: cachix/install-nix-action@456688f15bc354bef6d396e4a35f4f89d40bf2b7 # v31
      with:
        extra_nix_config: |
          # Filesets access the local path via fetchGit.
          allowed-uris = git+file://${{ github.workspace }} https://github.com
          nix-path = workspace=${{ github.workspace }} store=/nix/store
          restrict-eval = true
          # Sandbox is disabled on MacOS by default.
          sandbox = true

    - uses: cachix/cachix-action@0fc020193b5a1fa3ac4575aa3a7d3aa6a35435ad # v16
      with:
        # The nixpkgs-gha cache should not be trusted or used outside of Nixpkgs and its forks' CI.
        name: ${{ inputs.cachix-name || 'nixpkgs-gha' }}
        extraPullNames: nixpkgs-gha
        authToken: ${{ inputs.cachix-token }}
        pushFilter: '(-source$|-nixpkgs-tarball-|-single-chunk)'
