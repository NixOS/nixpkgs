# HG changeset patch
# User tmodes
# Date 1688055404 -7200
#      Thu Jun 29 18:16:44 2023 +0200
# Node ID 87ceecbc2bb5bf24a6e4f991d840275459502990
# Parent  d31e86e33f1fa4050ee2a9538136d003cd5ce200
Reject control characters when reading pto file

diff -r d31e86e33f1f -r 87ceecbc2bb5 src/hugin_base/panodata/Panorama.cpp
--- a/src/hugin_base/panodata/Panorama.cpp	Thu Jun 29 17:39:02 2023 +0200
+++ b/src/hugin_base/panodata/Panorama.cpp	Thu Jun 29 18:16:44 2023 +0200
@@ -2439,6 +2439,8 @@
     char * old_locale = strdup(p);
     setlocale(LC_NUMERIC,"C");
     std::string line;
+    // list of all control characters (char 0 .. 31)
+    const std::string controlCharacters { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31};
 
     // vector with the different information lines about images
     std::vector<PTScriptParsing::ImgInfo> oImgInfo;
@@ -2473,6 +2475,16 @@
     unsigned int lineNr = 0;    
     while (i.good()) {
         std::getline(i, line);
+        if (line.find_first_of(controlCharacters, 0) != std::string::npos)
+        {
+            // we found a binary character /control sequence in the text
+            // this is not allowed in a pto file
+            // reset locale
+            setlocale(LC_NUMERIC, old_locale);
+            free(old_locale);
+            // stop processing
+            return false;
+        };
         lineNr++;
         DEBUG_DEBUG(lineNr << ": " << line);
         if (skipNextLine) {
