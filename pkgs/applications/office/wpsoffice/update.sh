#! /usr/bin/env nix-shell
#! nix-shell -i bash --pure --keep GITHUB_TOKEN -p nix curl cacert nix-prefetch-git jq

url=$(curl 'https://plus.wps.cn/ops/opsd/api/v2/policy' --compressed -X POST -H 'Accept: application/json' -H 'Content-Type: application/json;charset=utf-8' --data-raw '{"entity_param":[{"window_key":"wps365_download_pc_muti"}]}' | jq '.windows[0].data[3].value | fromjson | .[4].links[1].link' | sed 's/"//g')
version=$(echo $url | awk -F'[_]' '{print $2}' | sed 's/office//g')
hash=$(nix hash to-sri --type sha256 "$(nix-prefetch-url $url)")

cat > sources.nix <<EOF
# Generated by ./update.sh - do not update manually!
# Last updated: $(date +%F)
{
  version = "$version";
  url = "$url";
  hash = "$hash";
}
EOF
