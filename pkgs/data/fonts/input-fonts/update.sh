#!/usr/bin/env nix-shell
#! nix-shell -i bash -p gawk nix-prefetch

prefetch() {
  hash=$(nix-prefetch "{ stdenv, callPackage }:
    let
      input-fonts = callPackage ./default.nix {
        acceptLicense = true;
        preset = \"$1\";
        lineHeight = \"$2\";
      };
    in input-fonts
  ")

  echo "$1,$2,$hash"
}

presets=(andale anonymous consolas default dejavu envy fira liberation monaco pragmata sourcecode)
lineHeights=$(seq 0.9 0.1 1.8)

for preset in "${presets[@]}"; do
  for lineHeight in $lineHeights; do
    prefetch "$preset" "$lineHeight"
  done
done | awk '
BEGIN {
  FS=","
  PROCINFO["sorted_in"] = "@val_num_asc"
  print "# This file is autogenerated by update.sh, do not edit!\n{"
} {
  presets[$1]
  lineHeights[$2]
  hashes[$1,$2]=$3
} END {
  for (preset in presets) {
    printf "  \"%s\" = {\n", preset
    for (lineHeight in lineHeights) {
      printf "    \"%s\" = \"%s\";\n", lineHeight, hashes[preset,lineHeight]
    }
    print "  };"
  }
  print "}"
}' > hashes.nix
