{ lib
, buildPythonApplication
, fetchFromGitHub
, jsonschema
, plotly
, beautifulsoup4
, pyyaml
, isort
, py
, jinja2
, rpmfile
, reportlab
, zstandard
, rich
, aiohttp
, toml
, distro
  # aiohttp[speedups]
, aiodns
, brotlipy
, faust-cchardet
, pillow
, pytestCheckHook
, xmlschema
, setuptools
, packaging
, cvss
, google-cloud-sdk
}:
buildPythonApplication rec {
  pname = "cve-bin-tool";
  version = "3.2";

  src = fetchFromGitHub {
    owner = "intel";
    repo = "cve-bin-tool";
    rev = "refs/tags/v${version}";
    sha256 = "sha256-QOnWt6iit0/F6d/MfZ8qJqDuT3IHh0Qjs6BcJkI/CBw=";
  };

  # Wants to open a sqlite database, access the internet, etc
  doCheck = false;

  propagatedBuildInputs = [
    jsonschema
    plotly
    beautifulsoup4
    pyyaml
    isort
    py
    jinja2
    rpmfile
    reportlab
    zstandard
    rich
    aiohttp
    toml
    distro
    # aiohttp[speedups]
    aiodns
    brotlipy
    faust-cchardet
    # needed by brotlipy
    pillow
    setuptools
    xmlschema
    packaging
    cvss
    google-cloud-sdk
  ];

  nativeCheckInputs = [
    pytestCheckHook
  ];

  pythonImportsCheck = [
    "cve_bin_tool"
  ];

  postPatch = ''
    # Since we disabled the tests for this, we do not care about pytest dependencies.
    sed '/^pytest/d' -i requirements.txt

    # This is used to upload and download data to GCE via the gsutil binary.
    # Therefore, this is not really a needed python dependency, therefore we just install google-cloud-sdk and
    # remove this dependency.
    sed '/^gsutil/d' -i requirements.txt

    # This was solved in https://github.com/intel/cve-bin-tool/pull/2432, but never released from requirements.txt
    sed 's/^packaging<22.0/packaging/i' -i requirements.txt
  '';

  meta = with lib; {
    description = "CVE Binary Checker Tool";
    homepage = "https://github.com/intel/cve-bin-tool";
    license = licenses.gpl3Plus;
    maintainers = [ ];
  };
}
