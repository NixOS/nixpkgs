{ stdenv, lib, fetchurl
, linkStatic ? (stdenv.hostPlatform.system == "i686-cygwin")
}:

# Note: this package is used for bootstrapping fetchurl, and thus
# cannot use fetchpatch! All mutable patches (generated by GitHub or
# cgit) that are needed here should be included directly in Nixpkgs as
# files.

stdenv.mkDerivation rec {
  pname = "bzip2";
  version = "1.0.8";

  src = fetchurl {
    url = "https://sourceware.org/pub/bzip2/${pname}-${version}.tar.gz";
    sha256 = "0s92986cv0p692icqlw1j42y9nld8zd83qwhzbqd61p1dqbh6nmb";
  };

  outputs = [ "bin" "dev" "out" "man" ] ++ lib.optionals linkStatic [ "static" ];

  buildPhase = ''
    cc=${cc:-$CC}
    make CC=cc
    make CC=cc -f Makefile-libbz2_so
  '';

  installFlags = [ "PREFIX=$(out)" ];

  postInstall = ''
    moveToOutput bin $bin
    ln -s libbz2.so.1.0 libbz2.so.1
    ln -s libbz2.so.1   libbz2.so
    mv libbz2.so* $out/lib
  '' + (if linkStatic  then ''
    mkdir -p $static/lib
    mv $out/lib/libz2.a $static/lib/libz2.a
  '' else ''
    rm $out/lib/libbz2.a
  '');

  enableParallelBuilding = true;

  meta = with stdenv.lib; {
    description = "High-quality data compression program";
    license = licenses.bsdOriginal;
    platforms = platforms.all;
    maintainers = [];
  };
}
