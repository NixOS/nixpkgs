From 0bdccc7ea453df4030787da073f55f2d7b10803a Mon Sep 17 00:00:00 2001
From: Ahmed Lekssays <lekssaysahmed@gmail.com>
Date: Thu, 6 Nov 2025 11:22:01 +0300
Subject: [PATCH] Fix UAF in xmlSetTreeDoc() - Issue #1012

---
 tree.c | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/tree.c b/tree.c
index e4fd0d6e5..bd345ae25 100644
--- a/tree.c
+++ b/tree.c
@@ -2586,10 +2586,12 @@ xmlNodeSetDoc(xmlNodePtr node, xmlDocPtr doc) {
 int
 xmlSetTreeDoc(xmlNode *tree, xmlDoc *doc) {
     int ret = 0;
+    xmlDocPtr oldDoc;
 
     if ((tree == NULL) || (tree->type == XML_NAMESPACE_DECL))
 	return(0);
-    if (tree->doc == doc)
+    oldDoc = tree->doc;
+    if (oldDoc == doc)
         return(0);
 
     if (tree->type == XML_ELEMENT_NODE) {
@@ -2617,6 +2619,18 @@ xmlSetTreeDoc(xmlNode *tree, xmlDoc *doc) {
     if (xmlNodeSetDoc(tree, doc) < 0)
         ret = -1;
 
+    /*
+     * Reconcile namespaces when moving between documents.
+     * This prevents use-after-free when namespaces from the old
+     * document are accessed after the old document is freed.
+     */
+    if ((ret == 0) && (oldDoc != doc) && (tree->type == XML_ELEMENT_NODE)) {
+        if (xmlReconciliateNs(doc, tree) < 0) {
+            /* Reconciliation failed, but document was already changed */
+            ret = -1;
+        }
+    }
+
     return(ret);
 }
 
-- 
GitLab

