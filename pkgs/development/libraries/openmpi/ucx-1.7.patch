From a3026c016a6a8be379f62585b6ddc070175c8106 Mon Sep 17 00:00:00 2001
From: Nathan Hjelm <hjelmn@google.com>
Date: Tue, 5 Nov 2019 12:52:42 -0800
Subject: [PATCH] btl/uct: fix compilation for UCX 1.7.0

Ref #7128

Signed-off-by: Nathan Hjelm <hjelmn@google.com>
---
 opal/mca/btl/uct/btl_uct.h           |  3 ++-
 opal/mca/btl/uct/btl_uct_component.c | 14 +++++++-------
 opal/mca/btl/uct/btl_uct_rdma.h      |  4 ++--
 opal/mca/btl/uct/btl_uct_tl.c        |  2 +-
 4 files changed, 12 insertions(+), 11 deletions(-)

diff --git a/opal/mca/btl/uct/btl_uct.h b/opal/mca/btl/uct/btl_uct.h
index 73640103c07..0e4ec9a9498 100644
--- a/opal/mca/btl/uct/btl_uct.h
+++ b/opal/mca/btl/uct/btl_uct.h
@@ -12,6 +12,7 @@
  *                         All rights reserved.
  * Copyright (c) 2015-2018 Los Alamos National Security, LLC. All rights
  *                         reserved.
+ * Copyright (c) 2019      Google, LLC. All rights reserved.
  * $COPYRIGHT$
  *
  * Additional copyrights may follow
@@ -85,7 +86,7 @@ struct mca_btl_uct_module_t {
     /** array containing the am_tl and rdma_tl */
     mca_btl_uct_tl_t *comm_tls[2];
 
-#if UCT_API > UCT_VERSION(1, 7)
+#if UCT_API >= UCT_VERSION(1, 7)
     uct_component_h uct_component;
 #endif
 
diff --git a/opal/mca/btl/uct/btl_uct_component.c b/opal/mca/btl/uct/btl_uct_component.c
index a4073208f8d..5088ad67e5a 100644
--- a/opal/mca/btl/uct/btl_uct_component.c
+++ b/opal/mca/btl/uct/btl_uct_component.c
@@ -316,7 +316,7 @@ ucs_status_t mca_btl_uct_am_handler (void *arg, void *data, size_t length, unsig
     return UCS_OK;
 }
 
-#if UCT_API > UCT_VERSION(1, 7)
+#if UCT_API >= UCT_VERSION(1, 7)
 static int mca_btl_uct_component_process_uct_md (uct_component_h component, uct_md_resource_desc_t *md_desc,
                                                  char **allowed_ifaces)
 #else
@@ -356,7 +356,7 @@ static int mca_btl_uct_component_process_uct_md (uct_md_resource_desc_t *md_desc
     md = OBJ_NEW(mca_btl_uct_md_t);
 
 
-#if UCT_API > UCT_VERSION(1, 7)
+#if UCT_API >= UCT_VERSION(1, 7)
     uct_md_config_read (component, NULL, NULL, &uct_config);
     uct_md_open (component, md_desc->md_name, uct_config, &md->uct_md);
 #else
@@ -388,7 +388,7 @@ static int mca_btl_uct_component_process_uct_md (uct_md_resource_desc_t *md_desc
         return OPAL_ERR_NOT_AVAILABLE;
     }
 
-#if UCT_API > UCT_VERSION(1, 7)
+#if UCT_API >= UCT_VERSION(1, 7)
     module->uct_component = component;
 #endif
 
@@ -417,7 +417,7 @@ static int mca_btl_uct_component_process_uct_md (uct_md_resource_desc_t *md_desc
     return OPAL_SUCCESS;
 }
 
-#if UCT_API > UCT_VERSION(1, 7)
+#if UCT_API >= UCT_VERSION(1, 7)
 static int mca_btl_uct_component_process_uct_component (uct_component_h component, char **allowed_ifaces)
 {
     uct_component_attr_t attr = {.field_mask = UCT_COMPONENT_ATTR_FIELD_NAME |
@@ -451,7 +451,7 @@ static int mca_btl_uct_component_process_uct_component (uct_component_h componen
 
     return OPAL_SUCCESS;
 }
-#endif /* UCT_API > UCT_VERSION(1, 7) */
+#endif /* UCT_API >= UCT_VERSION(1, 7) */
 
 /*
  *  UCT component initialization:
@@ -487,7 +487,7 @@ static mca_btl_base_module_t **mca_btl_uct_component_init (int *num_btl_modules,
 
     mca_btl_uct_component.module_count = 0;
 
-#if UCT_API > UCT_VERSION(1, 7)
+#if UCT_API >= UCT_VERSION(1, 7)
     uct_component_h *components;
     unsigned num_components;
 
@@ -521,7 +521,7 @@ static mca_btl_base_module_t **mca_btl_uct_component_init (int *num_btl_modules,
 
     uct_release_md_resource_list (resources);
 
-#endif /* UCT_API > UCT_VERSION(1, 7) */
+#endif /* UCT_API >= UCT_VERSION(1, 7) */
 
     opal_argv_free (allowed_ifaces);
     mca_btl_uct_modex_send ();
diff --git a/opal/mca/btl/uct/btl_uct_rdma.h b/opal/mca/btl/uct/btl_uct_rdma.h
index 609fec91f52..ab790371afe 100644
--- a/opal/mca/btl/uct/btl_uct_rdma.h
+++ b/opal/mca/btl/uct/btl_uct_rdma.h
@@ -55,7 +55,7 @@ static inline int mca_btl_uct_get_rkey (mca_btl_uct_module_t *module,
         return rc;
     }
 
-#if UCT_API > UCT_VERSION(1, 7)
+#if UCT_API >= UCT_VERSION(1, 7)
     ucs_status = uct_rkey_unpack (module->uct_component, (void *) remote_handle, rkey);
 #else
     ucs_status = uct_rkey_unpack ((void *) remote_handle, rkey);
@@ -65,7 +65,7 @@ static inline int mca_btl_uct_get_rkey (mca_btl_uct_module_t *module,
 
 static inline void mca_btl_uct_rkey_release (mca_btl_uct_module_t *uct_btl, uct_rkey_bundle_t *rkey)
 {
-#if UCT_API > UCT_VERSION(1, 7)
+#if UCT_API >= UCT_VERSION(1, 7)
     uct_rkey_release (uct_btl->uct_component, rkey);
 #else
     (void) uct_btl;
diff --git a/opal/mca/btl/uct/btl_uct_tl.c b/opal/mca/btl/uct/btl_uct_tl.c
index 7d5d519abbc..502fbba7567 100644
--- a/opal/mca/btl/uct/btl_uct_tl.c
+++ b/opal/mca/btl/uct/btl_uct_tl.c
@@ -522,7 +522,7 @@ static int mca_btl_uct_evaluate_tl (mca_btl_uct_module_t *module, mca_btl_uct_tl
 	 * come up with a better estimate. */
 
 	/* UCT bandwidth is in bytes/sec, BTL is in MB/sec */
-#if UCT_API > UCT_VERSION(1, 7)
+#if UCT_API >= UCT_VERSION(1, 7)
 	module->super.btl_bandwidth = (uint32_t) ((MCA_BTL_UCT_TL_ATTR(tl, 0).bandwidth.dedicated +
                                                    MCA_BTL_UCT_TL_ATTR(tl, 0).bandwidth.shared /
                                                    (opal_process_info.num_local_peers + 1)) / 1048576.0);

