{ lib, stdenv, fetchurl }:

# Note: this package is used for bootstrapping fetchurl in the musl
# stdenv, and thus cannot use fetchpatch or fetchFromGitHub!
# All mutable patches (generated by GitHub or cgit) that are needed
# here should be included directly in Nixpkgs as files.

stdenv.mkDerivation rec {
  pname   = "mimalloc-minimal";
  version = "2.0.7";

  src = fetchurl {
    url = "https://github.com/microsoft/mimalloc/archive/refs/tags/v${version}.tar.gz";
    sha256 = "sha256-8jqsbHNZTkF69Qyzjx7+2I7x3BSkkPDv8Hx/eweYEKQ=";
  };

  buildPhase = ''
    $CC -shared -fPIC -I include/ -DMI_MALLOC_OVERRIDE -D__USE_ISOC11 -o libmimalloc.so src/static.c
  '';

  installPhase = ''
    install -Dm755 -t $out/lib libmimalloc.so
  '';

  meta = with lib; {
    description = "Compact, fast, general-purpose memory allocator";
    homepage    = "https://github.com/microsoft/mimalloc";
    license     = licenses.bsd2;
    platforms   = platforms.unix;
    maintainers = with maintainers; [ kamadorueda thoughtpolice ];
  };
}
