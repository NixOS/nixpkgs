#!/usr/bin/env bash
set -e

if [ ! -d "cef" ]; then
  git clone https://bitbucket.org/chromiumembedded/cef.git
fi

cd cef
git fetch

branch="$(git branch --list --all | sed -n 's,.*remotes/origin/\([0-9][0-9]*\),\1,p' | sort -n | tail -n 1)"

git checkout origin/$branch
chromiumver="$(cat CHROMIUM_BUILD_COMPATIBILITY.txt | sed -n "s,.*'refs/tags/\([^']*\)'.*,\1,p")"

for pkg in chromium chromiumBeta chromiumDev; do
  eval "pkgver=$(nix-instantiate --eval '<nixpkgs>' -A ${pkg}.version)"
  if [ "$pkgver" = "$chromiumver" ]; then
    neededpkg="$pkg"
    break
  fi
done

if [ -z "$neededpkg" ]; then
  echo "Need Chromium version $chromiumver, but it wasn't found" >&2
  exit 1
fi

rev="$(git log -1 --format="%H")"
commitno="$(git rev-list --count HEAD)"
sha256="$(nix-prefetch-git "file://$PWD" "$rev" | sed -n 's,.*"sha256": "\([^"]*\)".*,\1,p')"

echo "# This file has been automatically generated by ./cef-update.sh"
echo
echo "{ $neededpkg }: {"
echo "  pkg = $neededpkg;"
echo "  branch = $branch;"
echo "  rev = \"$rev\";"
echo "  sha256 = \"$sha256\";"
echo "  commitNumber = $commitno;"
echo "  chromiumVersion = \"$chromiumver\";"
echo "}"
