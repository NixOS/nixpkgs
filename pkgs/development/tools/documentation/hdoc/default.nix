{ lib, stdenv, fetchFromGitHub
, cmake, llvmPackages, meson, ninja, openssl, pkg-config, xxd }:

stdenv.mkDerivation rec {
  pname = "hdoc";
  version = "1.3.2";

  src = fetchFromGitHub {
    owner = "hdoc";
    repo = pname;
    rev = version;
    sha256 = "sha256-6SXO762+thRlt+30Xr8iUgMfLe1ao626uYbORBMhx7g=";
  };

  nativeBuildInputs = [
    cmake
    meson
    ninja
    pkg-config
    xxd
  ];

  buildInputs = [
    openssl
    llvmPackages.clang-unwrapped
    llvmPackages.llvm
    llvmPackages.libclang
  ];

  # Configure with Meson, not CMake.
  dontUseCmakeConfigure = true;

  doCheck = true;
  checkPhase = ''
    ./index-tests
    ./unit-tests
  '';

  installPhase = ''
    mkdir -p $out/bin
    cp hdoc $out/bin/
    cp hdoc-client $out/bin/
  '';

  meta = {
    homepage = "https://hdoc.io/";
    description = "Modern documentation tool for C++";
    license = lib.licenses.agpl3Only;
    maintainers = with lib.maintainers; [ strager ];
    changelog = "https://hdoc.io/release-notes/";

    longDescription = ''
      Autogenerated API documentation. Integrated Markdown pages. Instant
      search. Beautiful output. Create great documentation, painlessly.
    '';
  };
}
