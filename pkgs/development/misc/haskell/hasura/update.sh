#!/usr/bin/env nix-shell
#!nix-shell -i bash -p cabal2nix curl jq -I nixpkgs=.
#
# This script will update the hasura derivations to the latest version using
# cabal2nix.
#
# Note that you should always try building hasura graphql-engine after updating it here, since
# some of the overrides in pkgs/development/haskell/configuration-nix.nix may
# need to be updated/changed.

set -eo pipefail

maintainerFlags=(
    "--maintainer" "lassulus"
)

# This is the directory of this update.sh script.
script_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

hasuraCabal2nix() {
    name="$1"; shift

    file="${script_dir}/${name}.nix"

    echo "Running cabal2nix for $name and writing to $file" >&2

    echo '# This file has been automatically generated by the script
# ./update.sh.  This should not be changed by hand.' > "$file"
    cabal2nix "${maintainerFlags[@]}" "$@" > "$file"
}

# TODO: get current revision of graphql-engine in Nixpkgs.
# old_version="$(sed -En 's/.*\bversion = "(.*?)".*/\1/p' "$engine_derivation_file")"

# This is the latest release version of graphql-engine on GitHub.
new_version=$(curl --silent "https://api.github.com/repos/hasura/graphql-engine/releases" | jq 'map(select(.prerelease | not)) | .[0].tag_name' --raw-output)
new_kritilang_version=$(curl --silent "https://api.github.com/repos/hasura/kriti-lang/tags" | jq '.[0].name' --raw-output)

hasuraCabal2nix graphql-engine --revision "$new_version" --subpath server --no-check "https://github.com/hasura/graphql-engine.git"
hasuraCabal2nix graphql-parser "https://github.com/hasura/graphql-parser-hs.git"
hasuraCabal2nix ci-info "https://github.com/hasura/ci-info-hs.git"
hasuraCabal2nix pg-client "https://github.com/hasura/pg-client-hs.git"
hasuraCabal2nix pool "https://github.com/hasura/pool.git"
hasuraCabal2nix ekg-core "https://github.com/hasura/ekg-core.git"
hasuraCabal2nix ekg-json "https://github.com/hasura/ekg-json.git"
hasuraCabal2nix kriti-lang --revision "$new_kritilang_version" "https://github.com/hasura/kriti-lang.git"

echo "###################" >&2
echo "please update pkgs/servers/hasura/cli.nix vendorSha256" >&2
echo "please update pkgs/development/haskell-modules/configuration-common.nix graphql-engine version" >&2
echo "###################" >&2

echo "Finished." >&2
