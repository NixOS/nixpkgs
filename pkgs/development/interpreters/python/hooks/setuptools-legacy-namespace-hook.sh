# Setup hook for setuptools.
echo "Sourcing setuptools-legacy-namespace-hook"

setuptoolsLegacyNamespaceFixupPhase() {
    echo "Executing setuptoolsLegacyNamespaceFixupPhase"

    # We are going to delete every *-nspkg.pth file, which is generated by
    # setuptools when a package uses the legacy namespace package code path
    # (when using the namespace_packages keyword in setup.{cfg,py}).
    #
    # These files can cause subtle problems when used alongside packages that
    # use a more modern code path that no longer generates those files. See:
    #
    #   https://github.com/pypa/setuptools/discussions/3991
    #
    SETUPTOOLS_NSPKG_PTH_FILES="$(find "$out/lib" -type f -name '*-nspkg.pth')"
    if [[ -n "$SETUPTOOLS_NSPKG_PTH_FILES" ]]; then
      find "$out/lib" -type f -name '*-nspkg.pth' -delete
    else
      echo "No nspkg.pth file is generated anymore. Please remove the setuptoolsLegacyNamespaceHook hook."
      exit 1
    fi

    echo "Finished executing setuptoolsLegacyNamespaceFixupPhase"
}

echo "Using setuptoolsLegacyNamespaceFixupPhase"
preFixupPhases+=" setuptoolsLegacyNamespaceFixupPhase"
