From e902698a4ff414fff1a1086a60e40387aa561dd4 Mon Sep 17 00:00:00 2001
From: superherointj <5861043+superherointj@users.noreply.github.com>
Date: Mon, 9 May 2022 12:01:18 -0300
Subject: [PATCH] fpc: mark paths for substitution in postPatch


diff --git a/compiler/systems/t_linux.pas b/compiler/systems/t_linux.pas
index febd93d8ac..dc03f02b52 100644
--- a/compiler/systems/t_linux.pas
+++ b/compiler/systems/t_linux.pas
@@ -126,6 +126,8 @@ procedure SetupLibrarySearchPath;
 begin
   if not Dontlinkstdlibpath Then
     begin
+      LibrarySearchPath.AddLibraryPath(sysrootpath,'=@syslibpath@',true);
+
 {$ifdef x86_64}
       { some linuxes might not have the lib64 variants (Arch, LFS }
       { don't use PathExists checks, as we need to take sysroots and
@@ -210,65 +212,65 @@ procedure SetupLibrarySearchPath;
 end;
 
 {$ifdef m68k}
-  const defdynlinker='/lib/ld.so.1';
+  const defdynlinker='@dynlinker-prefix@/lib/ld.so.1';
 {$endif m68k}
 
 {$ifdef i386}
-  const defdynlinker='/lib/ld-linux.so.2';
+  const defdynlinker='@dynlinker-prefix@/lib/ld-linux.so.2';
 {$endif}
 
 {$ifdef x86_64}
-  const defdynlinker='/lib64/ld-linux-x86-64.so.2';
+  const defdynlinker='@dynlinker-prefix@/lib64/ld-linux-x86-64.so.2';
 {$endif x86_64}
 
 {$ifdef sparc}
-  const defdynlinker='/lib/ld-linux.so.2';
+  const defdynlinker='@dynlinker-prefix@/lib/ld-linux.so.2';
 {$endif sparc}
 
 {$ifdef powerpc}
-  const defdynlinker='/lib/ld.so.1';
+  const defdynlinker='@dynlinker-prefix@/lib/ld.so.1';
 {$endif powerpc}
 
 {$ifdef powerpc64}
-  const defdynlinkerv1='/lib64/ld64.so.1';
-  const defdynlinkerv2='/lib64/ld64.so.2';
+  const defdynlinkerv1='@dynlinker-prefix@/lib64/ld64.so.1';
+  const defdynlinkerv2='@dynlinker-prefix@/lib64/ld64.so.2';
   var defdynlinker: string;
 {$endif powerpc64}
 
 {$ifdef arm}
 {$ifdef FPC_ARMHF}
-  const defdynlinker='/lib/ld-linux-armhf.so.3';
+  const defdynlinker='@dynlinker-prefix@/lib/ld-linux-armhf.so.3';
 {$else FPC_ARMHF}
 {$ifdef FPC_ARMEL}
-  const defdynlinker='/lib/ld-linux.so.3';
+  const defdynlinker='@dynlinker-prefix@/lib/ld-linux.so.3';
 {$else FPC_ARMEL}
-  const defdynlinker='/lib/ld-linux.so.2';
+  const defdynlinker='@dynlinker-prefix@/lib/ld-linux.so.2';
 {$endif FPC_ARMEL}
 {$endif FPC_ARMHF}
 {$endif arm}
 
 {$ifdef aarch64}
-const defdynlinker='/lib/ld-linux-aarch64.so.1';
+const defdynlinker='@dynlinker-prefix@/lib/ld-linux-aarch64.so.1';
 {$endif aarch64}
 
 {$ifdef mips}
-  const defdynlinker='/lib/ld.so.1';
+  const defdynlinker='@dynlinker-prefix@/lib/ld.so.1';
 {$endif mips}
 
 {$ifdef sparc64}
-  const defdynlinker='/lib64/ld-linux.so.2';
+  const defdynlinker='@dynlinker-prefix@/lib64/ld-linux.so.2';
 {$endif sparc64}
 
 {$ifdef riscv32}
-  const defdynlinker='/lib32/ld.so.1';
+  const defdynlinker='@dynlinker-prefix@/lib32/ld.so.1';
 {$endif riscv32}
 
 {$ifdef riscv64}
-  const defdynlinker='/lib/ld-linux-riscv64-lp64d.so.1';
+  const defdynlinker='@dynlinker-prefix@/lib/ld-linux-riscv64-lp64d.so.1';
 {$endif riscv64}
 
 {$ifdef xtensa}
-  const defdynlinker='/lib/ld.so.1';
+  const defdynlinker='@dynlinker-prefix@/lib/ld.so.1';
 {$endif xtensa}
 
 
@@ -303,9 +305,9 @@ procedure SetupDynlinker(out DynamicLinker:string;out libctype:TLibcType);
       libctype:=uclibc;
     end
 {$ifdef i386}
-  else if FileExists(sysrootpath+'/lib/ld-linux.so.1',false) then
+  else if FileExists(sysrootpath+'@dynlinker-prefix@/lib/ld-linux.so.1',false) then
     begin
-      DynamicLinker:='/lib/ld-linux.so.1';
+      DynamicLinker:='@dynlinker-prefix@/lib/ld-linux.so.1';
       libctype:=glibc2;
     end
 {$endif i386}
-- 
2.36.0

