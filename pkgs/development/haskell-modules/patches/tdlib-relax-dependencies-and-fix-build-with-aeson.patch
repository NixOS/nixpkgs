From fba4ef913ca01890b2c3daca414e7ec6473caf36 Mon Sep 17 00:00:00 2001
From: Dmitry Bogatov <serenity@kaction.cc>
Date: Sat, 18 Feb 2023 23:00:48 -0500
Subject: [PATCH 1/2] Relax dependencies to build with recent polysemy and
 aeson

---
 package.yaml | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/package.yaml b/package.yaml
index 17008b5..c0374dd 100644
--- a/package.yaml
+++ b/package.yaml
@@ -23,12 +23,12 @@ dependencies:
   - base >= 4.10 && < 5
   - bytestring
   - text
-  - aeson >= 1.4.7 && < 1.6
+  - aeson >= 1.4.7
   - containers ^>= 0.6.2.1
   - unordered-containers ^>= 0.2.10.0
   - stm ^>= 2.5.0.0
-  - polysemy ^>= 1.3.0.0
-  - polysemy-plugin ^>= 0.2.5.0
+  - polysemy >= 1.3.0.0
+  - polysemy-plugin >= 0.2.5.0
   - monad-loops
   - tdlib-types ^>= 0.4.0
 

From 8eb9ecbc98c65a715469fdb8b67793ab375eda31 Mon Sep 17 00:00:00 2001
From: Dmitry Bogatov <serenity@kaction.cc>
Date: Sat, 18 Feb 2023 23:10:12 -0500
Subject: [PATCH 2/2] Fix build with aeson >= 2.0.0

---
 src/TDLib/EventLoop.hs | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/src/TDLib/EventLoop.hs b/src/TDLib/EventLoop.hs
index cf7a9b4..bd90b8e 100644
--- a/src/TDLib/EventLoop.hs
+++ b/src/TDLib/EventLoop.hs
@@ -1,3 +1,4 @@
+{-# LANGUAGE CPP #-}
 {-# LANGUAGE ExistentialQuantification #-}
 
 -- | A heavyweight TDLib effect intepreter written using event loop
@@ -20,7 +21,11 @@ import Control.Monad
 import Control.Monad.Loops
 import Data.Aeson
 import Data.ByteString.Lazy (toStrict)
+#if MIN_VERSION_aeson(2,0,0)
+import qualified Data.Aeson.KeyMap as HM
+#else
 import qualified Data.HashMap.Strict as HM
+#endif
 import Data.IntMap.Strict (IntMap)
 import qualified Data.IntMap.Strict as M
 import Data.Maybe
