From 50654fe57da6fd1513f745c6ed08c735751433d4 Mon Sep 17 00:00:00 2001
From: Randy Eckenrode <randy@largeandhighquality.com>
Date: Mon, 15 Apr 2024 20:47:59 -0400
Subject: [PATCH 4/6] Use nixpkgs clang with the assembler driver

---
 as/driver.c | 23 +++++------------------
 1 file changed, 5 insertions(+), 18 deletions(-)

diff --git a/as/driver.c b/as/driver.c
index a0d49ad..4b70a56 100644
--- a/as/driver.c
+++ b/as/driver.c
@@ -36,7 +36,6 @@ char **envp)
     char *p, c, *arch_name, *as, *as_local;
     char **new_argv;
     const char *CLANG = "clang";
-    char *prefix, buf[MAXPATHLEN], resolved_name[PATH_MAX];
     uint32_t bufsize;
     struct arch_flag arch_flag;
     const struct arch_flag *arch_flags, *family_arch_flag;
@@ -53,19 +52,7 @@ char **envp)
 	/*
 	 * Construct the prefix to the assembler driver.
 	 */
-	bufsize = MAXPATHLEN;
-	p = buf;
-	i = _NSGetExecutablePath(p, &bufsize);
-	if(i == -1){
-	    p = allocate(bufsize);
-	    _NSGetExecutablePath(p, &bufsize);
-	}
-	prefix = realpath(p, resolved_name);
-	if(prefix == NULL)
-	    system_fatal("realpath(3) for %s failed", p);
-	p = rindex(prefix, '/');
-	if(p != NULL)
-	    p[1] = '\0';
+	const char *prefix = "@clang-unwrapped@";
 	/*
 	 * Process the assembler flags exactly like the assembler would (except
 	 * let the assembler complain about multiple flags, bad combinations of
@@ -365,7 +352,7 @@ char **envp)
 	/*
 	 * If this assembler exist try to run it else print an error message.
 	 */
-	as = makestr(prefix, LIB, arch_name, AS, NULL);
+	as = makestr(LIB, arch_name, AS, NULL);
 	new_argv = allocate((argc + 1) * sizeof(char *));
 	new_argv[0] = as;
 	j = 1;
@@ -387,7 +374,7 @@ char **envp)
 	    else
 		exit(1);
 	}
-	as_local = makestr(prefix, LOCALLIB, arch_name, AS, NULL);
+	as_local = makestr(LOCALLIB, arch_name, AS, NULL);
 	new_argv[0] = as_local;
 	if(access(as_local, F_OK) == 0){
 	    argv[0] = as_local;
@@ -401,7 +388,7 @@ char **envp)
 	arch_flags = get_arch_flags();
 	count = 0;
 	for(i = 0; arch_flags[i].name != NULL; i++){
-	    as = makestr(prefix, LIB, arch_flags[i].name, AS, NULL);
+	    as = makestr(LIB, arch_flags[i].name, AS, NULL);
 	    if(access(as, F_OK) == 0){
 		if(count == 0)
 		    printf("Installed assemblers are:\n");
@@ -409,7 +396,7 @@ char **envp)
 		count++;
 	    }
 	    else{
-		as_local = makestr(prefix, LOCALLIB, arch_flags[i].name, AS,
+		as_local = makestr(LOCALLIB, arch_flags[i].name, AS,
 				   NULL);
 		if(access(as_local, F_OK) == 0){
 		    if(count == 0)
-- 
2.44.0

