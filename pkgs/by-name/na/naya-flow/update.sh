#!/usr/bin/env nix-shell
#! nix-shell -i bash --pure -p cacert curl nix

set -euo pipefail

cd $(readlink -e $(dirname "${BASH_SOURCE[0]}"))
VERSION=$1

aarch64_darwin_version=${VERSION}

aarch64_darwin_url="https://github.com/NayaTech/NayaFlow-releases/releases/download/v${VERSION}/NayaFlow-arm64.dmg"

aarch64_darwin_hash=$(nix-prefetch-url "$aarch64_darwin_url")

# use friendlier hashes
aarch64_darwin_hash=$(nix --extra-experimental-features nix-command hash convert --to sri --hash-algo sha256 "$aarch64_darwin_hash")

cat >sources.nix <<EOF
# Generated by ./update.sh - do not update manually!
# Last updated: $(date +%F)
{ fetchurl }:
{
  aarch64-darwin = {
    version = "$aarch64_darwin_version";
    src = fetchurl {
      url = "$aarch64_darwin_url";
      hash = "$aarch64_darwin_hash";
    };
  };
}
EOF
