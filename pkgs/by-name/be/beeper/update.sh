#!/usr/bin/env nix-shell
#! nix-shell -i bash --pure -p cacert curl nix
set -euo pipefail
cd "$(readlink -e "$(dirname "${BASH_SOURCE[0]}")")"

extract_version () {
  echo "$1" | grep --only-matching --extended-regexp '[0-9]+\.[0-9]+\.[0-9]+'
}
version_hash () {
  url=$(curl --silent --output /dev/null --write-out '%{redirect_url}\n' "$1")
  version=$(extract_version "$url")
  output=$(nix-prefetch-url "$url")
  hash=$(nix --extra-experimental-features nix-command hash convert "sha256:$output")
  echo "$url" "$version" "$hash"
}

read aarch64_darwin_url aarch64_darwin_version aarch64_darwin_hash < <(version_hash https://api.beeper.com/desktop/download/macos/arm64/stable/com.automattic.beeper.desktop)
read x86_64_darwin_url x86_64_darwin_version x86_64_darwin_hash < <(version_hash https://api.beeper.com/desktop/download/macos/x64/stable/com.automattic.beeper.desktop)
read aarch64_linux_url aarch64_linux_version aarch64_linux_hash < <(version_hash https://api.beeper.com/desktop/download/linux/arm64/stable/com.automattic.beeper.desktop)
read x86_64_linux_url x86_64_linux_version x86_64_linux_hash < <(version_hash https://api.beeper.com/desktop/download/linux/x64/stable/com.automattic.beeper.desktop)


cat >sources.nix <<EOF
# Generated by ./update.sh - do not update manually!
# Last updated: $(date +%F)
{ fetchurl }:
{
  aarch64-darwin = {
    version = "$aarch64_darwin_version";
    src = fetchurl {
      url = "$aarch64_darwin_url";
      hash = "$aarch64_darwin_hash";
    };
  };
  x86_64-darwin = {
    version = "$x86_64_darwin_version";
    src = fetchurl {
      url = "$x86_64_darwin_url";
      hash = "$x86_64_darwin_hash";
    };
  };
  aarch64-linux = {
    version = "$aarch64_linux_version";
    src = fetchurl {
      url = "$aarch64_linux_url";
      hash = "$aarch64_linux_hash";
    };
  };
  x86_64-linux = {
    version = "$x86_64_linux_version";
    src = fetchurl {
      url = "$x86_64_linux_url";
      hash = "$x86_64_linux_hash";
    };
  };
}
EOF
