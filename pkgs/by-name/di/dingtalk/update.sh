#!/usr/bin/env nix-shell
#!nix-shell -i bash -p curl jq nix-prefetch gnugrep

set -euo pipefail

cd "$(dirname "${BASH_SOURCE[0]}")"

get_actual_url() {
    curl -sL -o /dev/null -w "%{url_effective}" \
         -H "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
         "$1"
}

LINUX_AARCH64_URL="https://www.dingtalk.com/win/d/qd=linux_arm64"
LINUX_AARCH64_ACTUAL_URL=$(get_actual_url "$LINUX_AARCH64_URL")

LINUX_X86_64_URL="https://www.dingtalk.com/win/d/qd=linux_amd64"
LINUX_X86_64_ACTUAL_URL=$(get_actual_url "$LINUX_X86_64_URL")

DARWIN_AARCH64_URL="https://www.dingtalk.com/mac/d/qd=mac-arm64"
DARWIN_AARCH64_ACTUAL_URL=$(get_actual_url "$DARWIN_AARCH64_URL")

DARWIN_X86_64_URL="https://www.dingtalk.com/mac/d/"
DARWIN_X86_64_ACTUAL_URL=$(get_actual_url "$DARWIN_X86_64_URL")

echo "=== DEBUG: Actual download URLs ==="
echo "Linux aarch64: $LINUX_AARCH64_ACTUAL_URL"
echo "Linux x86_64:  $LINUX_X86_64_ACTUAL_URL"
echo "Darwin arm64:  $DARWIN_AARCH64_ACTUAL_URL"
echo "Darwin x86_64: $DARWIN_X86_64_ACTUAL_URL"
echo "==================================="

extract_version() {
    local url="$1"
    local filename=$(basename "$url" | tr '[:upper:]' '[:lower:]' | sed 's/%20/ /g')

    # Darwin format: DingTalk_v8.2.0-Installer_51832624_arm64.dmg
    if [[ "$filename" =~ dingtalk_v([0-9]+\.[0-9]+\.[0-9]+)-installer_([0-9]+) ]]; then
        echo "${BASH_REMATCH[1]}"
        return
    fi

    # Linux format: com.alibabainc.dingtalk_7.8.15.5102301_arm64.deb
    if [[ "$filename" =~ com\.alibabainc\.dingtalk_([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+) ]]; then
        echo "${BASH_REMATCH[1]}"
        return
    fi

    # Fallback patterns
    if [[ "$filename" =~ ([0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?) ]]; then
        echo "${BASH_REMATCH[1]}"
        return
    fi

    echo "unknown"
}

DARWIN_VERSION=$(extract_version "$DARWIN_X86_64_ACTUAL_URL")
LINUX_VERSION=$(extract_version "$LINUX_X86_64_ACTUAL_URL")

echo "Detected Darwin version: $DARWIN_VERSION"
echo "Detected Linux version: $LINUX_VERSION"

get_nix_hash() {
    local url="$1"
    local name="$2"
    nix-prefetch-url --name "$name" "$url" 2>/dev/null || echo "0000000000000000000000000000000000000000000000000000"
}

LINUX_AARCH64_HASH=$(get_nix_hash "$LINUX_AARCH64_ACTUAL_URL" "dingtalk-linux-aarch64")
LINUX_X86_64_HASH=$(get_nix_hash "$LINUX_X86_64_ACTUAL_URL" "dingtalk-linux-amd64")
DARWIN_AARCH64_HASH=$(get_nix_hash "$DARWIN_AARCH64_ACTUAL_URL" "dingtalk-mac-arm64")
DARWIN_X86_64_HASH=$(get_nix_hash "$DARWIN_X86_64_ACTUAL_URL" "dingtalk-mac-universal")

to_sri() {
    local hash="$1"
    if [[ "$hash" == "0000000000000000000000000000000000000000000000000000" ]]; then
        echo "sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
    else
        nix hash to-sri --type sha256 "$hash" 2>/dev/null || echo "sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
    fi
}

cat > sources.nix << EOF
# Generated by ./update.sh - do not update manually.
# Last updated: $(date +%F)

{ fetchurl }:
{
  aarch64-darwin = {
    version = "$DARWIN_VERSION";
    src = fetchurl {
      url = "$DARWIN_AARCH64_ACTUAL_URL";
      hash = "$(to_sri "$DARWIN_AARCH64_HASH")";
    };
  };
  x86_64-darwin = {
    version = "$DARWIN_VERSION";
    src = fetchurl {
      url = "$DARWIN_X86_64_ACTUAL_URL";
      hash = "$(to_sri "$DARWIN_X86_64_HASH")";
    };
  };
  aarch64-linux = {
    version = "$LINUX_VERSION";
    src = fetchurl {
      url = "$LINUX_AARCH64_ACTUAL_URL";
      hash = "$(to_sri "$LINUX_AARCH64_HASH")";
    };
  };
  x86_64-linux = {
    version = "$LINUX_VERSION";
    src = fetchurl {
      url = "$LINUX_X86_64_ACTUAL_URL";
      hash = "$(to_sri "$LINUX_X86_64_HASH")";
    };
  };
}
EOF

echo "Successfully generated sources.nix"
