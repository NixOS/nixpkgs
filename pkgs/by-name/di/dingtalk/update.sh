#!/usr/bin/env nix-shell
#!nix-shell -i bash -p curl jq nix-prefetch

set -euo pipefail

cd "$(dirname "${BASH_SOURCE[0]}")"

# Linux aarch64
LINUX_AARCH64_URL="https://www.dingtalk.com/win/d/qd=linux_arm64"
LINUX_AARCH64_ACTUAL_URL=$(curl -sI "$LINUX_AARCH64_URL" | sed -n 's/^location: //ip' | tr -d '\r\n')
LINUX_AARCH64_HASH=$(nix-prefetch-url "$LINUX_AARCH64_ACTUAL_URL")

# Linux x86_64
LINUX_X86_64_URL="https://www.dingtalk.com/win/d/qd=linux_amd64"
LINUX_X86_64_ACTUAL_URL=$(curl -sI "$LINUX_X86_64_URL" | sed -n 's/^location: //ip' | tr -d '\r\n')
LINUX_X86_64_HASH=$(nix-prefetch-url "$LINUX_X86_64_ACTUAL_URL")

# Darwin aarch64 (Apple Silicon)
DARWIN_AARCH64_URL="https://www.dingtalk.com/mac/d/qd=mac-arm64"
DARWIN_AARCH64_ACTUAL_URL=$(curl -sI "$DARWIN_AARCH64_URL" | sed -n 's/^location: //ip' | tr -d '\r\n')
DARWIN_AARCH64_HASH=$(nix-prefetch-url "$DARWIN_AARCH64_ACTUAL_URL")

# Darwin x86_64 (Intel)
DARWIN_X86_64_URL="https://www.dingtalk.com/mac/d/"
DARWIN_X86_64_ACTUAL_URL=$(curl -sI "$DARWIN_X86_64_URL" | sed -n 's/^location: //ip' | tr -d '\r\n')
DARWIN_X86_64_HASH=$(nix-prefetch-url "$DARWIN_X86_64_ACTUAL_URL")

extract_version() {
    local filename=$(basename "$1")
    if [[ $filename == DingTalk_v* ]]; then
        # Darwin version extraction
        echo "$filename" | sed -n 's/DingTalk_v\([0-9.]*\)-Installer_\([0-9]*\).*/\1-\2/p'
    elif [[ $filename == com.alibabainc.dingtalk_* ]]; then
        # Linux version extraction
        echo "$filename" | sed -n 's/com.alibabainc.dingtalk_\([0-9.]*\).*/\1/p'
    fi
}

DARWIN_VERSION=$(extract_version "$DARWIN_X86_64_ACTUAL_URL")
LINUX_VERSION=$(extract_version "$LINUX_X86_64_ACTUAL_URL")

# Convert hashes to SRI format
LINUX_AARCH64_HASH=$(nix hash --extra-experimental-features nix-command to-sri --type sha256 "$LINUX_AARCH64_HASH")
LINUX_X86_64_HASH=$(nix hash --extra-experimental-features nix-command to-sri --type sha256 "$LINUX_X86_64_HASH")
DARWIN_AARCH64_HASH=$(nix hash --extra-experimental-features nix-command to-sri --type sha256 "$DARWIN_AARCH64_HASH")
DARWIN_X86_64_HASH=$(nix hash --extra-experimental-features nix-command to-sri --type sha256 "$DARWIN_X86_64_HASH")

cat > sources.nix << EOF
# Generated by ./update.sh - do not update manually.
# Last updated: $(date +%F)
{ fetchurl }:
{
  aarch64-darwin = {
    version = "$DARWIN_VERSION";
    src = fetchurl {
      url = "$DARWIN_AARCH64_ACTUAL_URL";
      hash = "$DARWIN_AARCH64_HASH";
    };
  };
  x86_64-darwin = {
    version = "$DARWIN_VERSION";
    src = fetchurl {
      url = "$DARWIN_X86_64_ACTUAL_URL";
      hash = "$DARWIN_X86_64_HASH";
    };
  };
  aarch64-linux = {
    version = "$LINUX_VERSION";
    src = fetchurl {
      url = "$LINUX_AARCH64_ACTUAL_URL";
      hash = "$LINUX_AARCH64_HASH";
    };
  };
  x86_64-linux = {
    version = "$LINUX_VERSION";
    src = fetchurl {
      url = "$LINUX_X86_64_ACTUAL_URL";
      hash = "$LINUX_X86_64_HASH";
    };
  };
}
EOF
