{
  lib,
  stdenv,
  buildDotnetModule,
  dotnetCorePackages,
  fetchFromGitHub,
  nix-update-script,
  autoPatchelfHook,
  copyDesktopItems,
  makeDesktopItem,
  icoutils,
  runtimeShell,
  aria2,
  ffmpeg,
  fontconfig,
  freetype,
  icu,
  krb5,
  openssl,
  zlib,
  lttng-ust_2_12,
  xorg,
}:

buildDotnetModule (finalAttrs: {
  pname = "downkyicore";
  version = "1.0.23";

  src = fetchFromGitHub {
    owner = "yaobiao131";
    repo = "downkyicore";
    tag = "v${finalAttrs.version}";
    hash = "sha256-1APolFe2eq7aIZdg3Sl4DI/6lnvaAgX/GDcHx3M+o/I=";
  };

  projectFile = "DownKyi/DownKyi.csproj";
  nugetDeps = ./deps.json;

  dotnet-sdk = dotnetCorePackages.sdk_8_0;
  dotnet-runtime = dotnetCorePackages.runtime_8_0;
  executables = [ "DownKyi" ];

  nativeBuildInputs = [
    copyDesktopItems
  ]
  ++ lib.optionals stdenv.hostPlatform.isLinux [
    autoPatchelfHook
    icoutils
  ];

  buildInputs = [
    aria2
    ffmpeg
  ]
  ++ lib.optionals stdenv.hostPlatform.isLinux [
    fontconfig
    freetype
    icu
    krb5
    openssl
    zlib
    lttng-ust_2_12
    (lib.getLib stdenv.cc.cc)
  ];

  runtimeDeps = lib.optionals stdenv.hostPlatform.isLinux (
    with xorg;
    [
      libX11
      libXcursor
      libXext
      libXi
      libXrandr
      libICE
      libSM
    ]
  );

  postPatch = ''
    substituteInPlace DownKyi/DownKyi.csproj DownKyi.Core/DownKyi.Core.csproj \
      --replace-fail net6.0 net8.0
  '';

  makeWrapperArgs = [
    "--chdir"
    "${placeholder "out"}/lib/downkyicore"
  ];

  passthru.updateScript = nix-update-script { };

  # Provide system ffmpeg/aria2 binaries and license texts where the app expects them.
  postInstall = ''
    mkdir -p $out/lib/downkyicore/{aria2,ffmpeg}

    ln -s ${lib.getExe aria2} $out/lib/downkyicore/aria2/aria2c
    ln -s ${lib.getExe' ffmpeg "ffmpeg"} $out/lib/downkyicore/ffmpeg/ffmpeg
    ln -s ${lib.getExe' ffmpeg "ffprobe"} $out/lib/downkyicore/ffmpeg/ffprobe

    printf 'See https://github.com/aria2/aria2/blob/master/COPYING for aria2 licensing information.\n' > $out/lib/downkyicore/aria2_COPYING.txt
    printf 'See https://ffmpeg.org/legal.html for FFmpeg licensing information.\n' > $out/lib/downkyicore/FFmpeg_LICENSE.txt

  ''
  + lib.optionalString stdenv.hostPlatform.isLinux ''
    icotool -x DownKyi/Resources/favicon.ico
    install -Dm444 \
      favicon_*_128x128x32.png \
      $out/share/icons/hicolor/128x128/apps/downkyicore.png
  ''
  + lib.optionalString stdenv.hostPlatform.isDarwin ''
    app="$out/Applications/DownKyi.app"
    mkdir -p "$app/Contents/MacOS" "$app/Contents/Resources"

    install -Dm644 ${./Info.plist} "$app/Contents/Info.plist"
    substituteInPlace "$app/Contents/Info.plist" \
      --replace-fail "@version@" "${finalAttrs.version}"

    cat > "$app/Contents/MacOS/DownKyi" <<'EOF'
    #! ${runtimeShell}
    exec "$out/bin/DownKyi" "$@"
    EOF
    chmod 755 "$app/Contents/MacOS/DownKyi"

    cp DownKyi/Resources/favicon.ico "$app/Contents/Resources/downkyicore.ico"
  '';

  desktopItems = lib.optionals stdenv.hostPlatform.isLinux [
    (makeDesktopItem {
      name = "downkyicore";
      desktopName = "DownKyi";
      comment = "Cross-platform Bilibili downloader";
      exec = "DownKyi";
      icon = "downkyicore";
      categories = [
        "Network"
        "AudioVideo"
      ];
    })
  ];

  meta = {
    description = "Cross-platform Bilibili downloader built with Avalonia";
    homepage = "https://github.com/yaobiao131/downkyicore";
    license = lib.licenses.gpl3Only;
    maintainers = with lib.maintainers; [ mio ];
    platforms = lib.platforms.linux ++ lib.platforms.darwin;
    mainProgram = "DownKyi";
  };
})
