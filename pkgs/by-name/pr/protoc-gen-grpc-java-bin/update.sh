#!/usr/bin/env nix-shell
#!nix-shell -i bash -p curl

set -eu -o pipefail

cd $(dirname $0)

baseurl=https://repo1.maven.org/maven2/io/grpc/protoc-gen-grpc-java

version=$(curl -s $baseurl/maven-metadata.xml | grep -oP '<latest>\K[^<]+')

url() {
    local system=$1
    echo $baseurl/$version/protoc-gen-grpc-java-$version-$system.exe
}

checksum() {
    local system=$1
    echo $(nix-hash --type sha256 --to-sri $(curl -s $(url $system).sha256))
}

sed -i "s/version = \".*\";/version = \"$version\";/" package.nix

cat << EOF > urls.nix
# This file was generated by update.sh

{
  x86_64-linux = {
    url = "$(url linux-x86_64)";
    hash = "$(checksum linux-x86_64)";
  };
  aarch64-linux = {
    url = "$(url linux-aarch_64)";
    hash = "$(checksum linux-aarch_64)";
  };
  x86_64-darwin = {
    url = "$(url osx-x86_64)";
    hash = "$(checksum osx-x86_64)";
  };
  aarch64-darwin = {
    url = "$(url osx-aarch_64)";
    hash = "$(checksum osx-aarch_64)";
  };
}
EOF
