From 62b7ba1b1a28a9e87793af78db5589aef67dd6b9 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@stgraber.org>
Date: Sat, 1 Mar 2025 02:31:49 -0500
Subject: [PATCH] incusd/instance/qemu: Provide the RBD keyring to QEMU
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Closes #1708

Signed-off-by: St√©phane Graber <stgraber@stgraber.org>
---
 internal/server/instance/drivers/driver_qemu.go | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/internal/server/instance/drivers/driver_qemu.go b/internal/server/instance/drivers/driver_qemu.go
index 1c7f98b1b9c..7593ba3d36f 100644
--- a/internal/server/instance/drivers/driver_qemu.go
+++ b/internal/server/instance/drivers/driver_qemu.go
@@ -4226,17 +4226,29 @@ func (d *qemu) addDriveConfig(qemuDev map[string]any, bootIndexes map[string]int
 		rbdImageName := storageDrivers.CephGetRBDImageName(vol, "", false)
 
 		// Scan & pass through options.
+		clusterName := storageDrivers.CephDefaultCluster
+		userName := storageDrivers.CephDefaultUser
+
 		blockDev["pool"] = poolName
 		blockDev["image"] = rbdImageName
 		for key, val := range opts {
 			// We use 'id' where qemu uses 'user'.
 			if key == "id" {
 				blockDev["user"] = val
+				userName = val
+			} else if key == "cluster" {
+				clusterName = val
 			} else {
 				blockDev[key] = val
 			}
 		}
 
+		// Parse the secret (QEMU runs unprivileged and can't read the keyring directly).
+		rbdSecret, err = storageDrivers.CephKeyring(clusterName, userName)
+		if err != nil {
+			return nil, err
+		}
+
 		// The aio option isn't available when using the rbd driver.
 		delete(blockDev, "aio")
 	}
