Index: plasma-workspace-5.17.0/sddm-theme/theme.conf.cmake
===================================================================
--- plasma-workspace-5.17.0.orig/sddm-theme/theme.conf.cmake
+++ plasma-workspace-5.17.0/sddm-theme/theme.conf.cmake
@@ -2,4 +2,4 @@
 type=image
 color=#1d99f3
 fontSize=10
-background=${CMAKE_INSTALL_PREFIX}/${WALLPAPER_INSTALL_DIR}/Next/contents/images/5120x2880.png
+background=${NIXPKGS_WALLPAPER_INSTALL_DIR}/Next/contents/images/5120x2880.png
Index: plasma-workspace-5.17.0/startkde/CMakeLists.txt
===================================================================
--- plasma-workspace-5.17.0.orig/startkde/CMakeLists.txt
+++ plasma-workspace-5.17.0/startkde/CMakeLists.txt
@@ -24,12 +24,6 @@ target_link_libraries(startplasma-waylan
 target_link_libraries(startplasma-waylandsession PRIVATE Qt5::Core Qt5::DBus KF5::ConfigCore)
 add_subdirectory(plasma-session)
 
-#FIXME: reconsider, looks fishy
-if(NOT CMAKE_INSTALL_PREFIX STREQUAL "/usr")
-    set_property(SOURCE startplasma.cpp APPEND PROPERTY COMPILE_DEFINITIONS
-        XCURSOR_PATH="${KDE_INSTALL_FULL_DATAROOTDIR}/icons:$XCURSOR_PATH:~/.icons:/usr/share/icons:/usr/share/pixmaps:/usr/X11R6/lib/X11/icons")
-endif()
-
 configure_file(config-startplasma.h.cmake ${CMAKE_CURRENT_BINARY_DIR}/config-startplasma.h)
 
 install(TARGETS startplasma-x11 ${KDE_INSTALL_TARGETS_DEFAULT_ARGS})
Index: plasma-workspace-5.17.0/startkde/startplasma.cpp
===================================================================
--- plasma-workspace-5.17.0.orig/startkde/startplasma.cpp
+++ plasma-workspace-5.17.0/startkde/startplasma.cpp
@@ -34,7 +34,7 @@ QTextStream out(stderr);
 void messageBox(const QString &text)
 {
     out << text;
-    runSync(QStringLiteral("xmessage"), {QStringLiteral("-geometry"), QStringLiteral("500x100"), text});
+    // runSync(QStringLiteral("xmessage"), {QStringLiteral("-geometry"), QStringLiteral("500x100"), text});
 }
 
 QStringList allServices(const QLatin1String& prefix)
@@ -240,15 +240,15 @@ void setupX11()
 //     If the user has overwritten fonts, the cursor font may be different now
 //     so don't move this up.
 
-    runSync(QStringLiteral("xsetroot"), {QStringLiteral("-cursor_name"), QStringLiteral("left_ptr")});
-    runSync(QStringLiteral("xprop"), {QStringLiteral("-root"), QStringLiteral("-f"), QStringLiteral("KDE_FULL_SESSION"), QStringLiteral("8t"), QStringLiteral("-set"), QStringLiteral("KDE_FULL_SESSION"), QStringLiteral("true")});
-    runSync(QStringLiteral("xprop"), {QStringLiteral("-root"), QStringLiteral("-f"), QStringLiteral("KDE_SESSION_VERSION"), QStringLiteral("32c"), QStringLiteral("-set"), QStringLiteral("KDE_SESSION_VERSION"), QStringLiteral("5")});
+    runSync(QStringLiteral("@NIXPKGS_XSETROOT@"), {QStringLiteral("-cursor_name"), QStringLiteral("left_ptr")});
+    runSync(QStringLiteral("@NIXPKGS_XPROP@"), {QStringLiteral("-root"), QStringLiteral("-f"), QStringLiteral("KDE_FULL_SESSION"), QStringLiteral("8t"), QStringLiteral("-set"), QStringLiteral("KDE_FULL_SESSION"), QStringLiteral("true")});
+    runSync(QStringLiteral("@NIXPKGS_XPROP@"), {QStringLiteral("-root"), QStringLiteral("-f"), QStringLiteral("KDE_SESSION_VERSION"), QStringLiteral("32c"), QStringLiteral("-set"), QStringLiteral("KDE_SESSION_VERSION"), QStringLiteral("5")});
 }
 
 void cleanupX11()
 {
-    runSync(QStringLiteral("xprop"), { QStringLiteral("-root"), QStringLiteral("-remove"), QStringLiteral("KDE_FULL_SESSION") });
-    runSync(QStringLiteral("xprop"), { QStringLiteral("-root"), QStringLiteral("-remove"), QStringLiteral("KDE_SESSION_VERSION") });
+    runSync(QStringLiteral("@NIXPKGS_XPROP@"), { QStringLiteral("-root"), QStringLiteral("-remove"), QStringLiteral("KDE_FULL_SESSION") });
+    runSync(QStringLiteral("@NIXPKGS_XPROP@"), { QStringLiteral("-root"), QStringLiteral("-remove"), QStringLiteral("KDE_SESSION_VERSION") });
 }
 
 // TODO: Check if Necessary
@@ -263,13 +263,8 @@ void cleanupPlasmaEnvironment()
 // In that case, the update in startplasma might be too late.
 bool syncDBusEnvironment()
 {
-    int exitCode;
     // At this point all environment variables are set, let's send it to the DBus session server to update the activation environment
-    if (!QStandardPaths::findExecutable(QStringLiteral("dbus-update-activation-environment")).isEmpty()) {
-        exitCode = runSync(QStringLiteral("dbus-update-activation-environment"), { QStringLiteral("--systemd"), QStringLiteral("--all") });
-    } else {
-        exitCode = runSync(QStringLiteral(CMAKE_INSTALL_FULL_LIBEXECDIR "/ksyncdbusenv"), {});
-    }
+    const int exitCode = runSync(QStringLiteral("@NIXPKGS_DBUS_UPDATE_ACTIVATION_ENVIRONMENT@"), { QStringLiteral("--systemd"), QStringLiteral("--all") });
     return exitCode == 0;
 }
 
@@ -307,7 +302,7 @@ QProcess* setupKSplash()
         KConfigGroup ksplashCfg = cfg.group("KSplash");
         if (ksplashCfg.readEntry("Engine", QStringLiteral("KSplashQML")) == QLatin1String("KSplashQML")) {
             p = new QProcess;
-            p->start(QStringLiteral("ksplashqml"), { ksplashCfg.readEntry("Theme", QStringLiteral("Breeze")) });
+            p->start(QStringLiteral(CMAKE_INSTALL_FULL_BINDIR "/ksplashqml"), { ksplashCfg.readEntry("Theme", QStringLiteral("org.kde.breeze.desktop")) });
         }
     }
     return p;
@@ -329,7 +324,7 @@ bool startKDEInit()
 {
     // We set LD_BIND_NOW to increase the efficiency of kdeinit.
     // kdeinit unsets this variable before loading applications.
-    const int exitCode = runSync(QStringLiteral(CMAKE_INSTALL_FULL_LIBEXECDIR_KF5 "/start_kdeinit_wrapper"), { QStringLiteral("--kded"), QStringLiteral("+kcminit_startup") }, { QStringLiteral("LD_BIND_NOW=true") });
+    const int exitCode = runSync(QStringLiteral("@NIXPKGS_START_KDEINIT_WRAPPER@"), { QStringLiteral("--kded"), QStringLiteral("+kcminit_startup") }, { QStringLiteral("LD_BIND_NOW=true") });
     if (exitCode != 0) {
         messageBox(QStringLiteral("startkde: Could not start kdeinit5. Check your installation."));
         return false;
Index: plasma-workspace-5.17.0/startkde/startplasma-x11.cpp
===================================================================
--- plasma-workspace-5.17.0.orig/startkde/startplasma-x11.cpp
+++ plasma-workspace-5.17.0/startkde/startplasma-x11.cpp
@@ -111,7 +111,7 @@ int main(int /*argc*/, char** /*argv*/)
 
     out << "startkde: Shutting down...\n";
 
-    runSync(QStringLiteral("kdeinit5_shutdown"), {});
+    runSync(QStringLiteral("@NIXPKGS_KDEINIT5_SHUTDOWN@"), {});
 
     cleanupPlasmaEnvironment();
     cleanupX11();
