From 3491f34683461734f562610ffd3573e1802004b0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Jos=C3=A9=20Romildo=20Malaquias?= <malaquias@gmail.com>
Date: Sun, 12 May 2019 08:50:07 -0300
Subject: [PATCH 1/4] Use qt library to determine where to look for application
 files

---
 dde-file-manager-lib/shutil/fileutils.cpp      | 18 ++++++++++++------
 .../shutil/mimesappsmanager.cpp                | 11 +++--------
 2 files changed, 15 insertions(+), 14 deletions(-)

diff --git a/dde-file-manager-lib/shutil/fileutils.cpp b/dde-file-manager-lib/shutil/fileutils.cpp
index 5a5c8dd2..be6aa181 100644
--- a/dde-file-manager-lib/shutil/fileutils.cpp
+++ b/dde-file-manager-lib/shutil/fileutils.cpp
@@ -243,13 +243,19 @@ bool FileUtils::isArchive(const QString &path)
  */
 QStringList FileUtils::getApplicationNames() {
   QStringList appNames;
-  QDirIterator it("/usr/share/applications", QStringList("*.desktop"),
-                  QDir::Files | QDir::NoDotAndDotDot,
-                  QDirIterator::Subdirectories);
-  while (it.hasNext()) {
-    it.next();
-    appNames.append(it.fileName());
+
+  const QStringList desktopDirs = QStandardPaths::standardLocations(QStandardPaths::ApplicationsLocation);
+  qDebug() << "dde-file-manager getApplicationNames desktopDirs:" << desktopDirs;
+  for (const QString &dir : desktopDirs) {
+    QDirIterator it(dir, QStringList("*.desktop"),
+                    QDir::Files | QDir::NoDotAndDotDot,
+                    QDirIterator::Subdirectories);
+    while (it.hasNext()) {
+      it.next();
+      appNames.append(it.fileName());
+    }
   }
+  
   return appNames;
 }
 
diff --git a/dde-file-manager-lib/shutil/mimesappsmanager.cpp b/dde-file-manager-lib/shutil/mimesappsmanager.cpp
index ed5f629d..ce14ecc1 100644
--- a/dde-file-manager-lib/shutil/mimesappsmanager.cpp
+++ b/dde-file-manager-lib/shutil/mimesappsmanager.cpp
@@ -548,14 +548,9 @@ QStringList MimesAppsManager::getrecommendedAppsFromMimeWhiteList(const DUrl &ur
 
 QStringList MimesAppsManager::getApplicationsFolders()
 {
-    QStringList desktopFolders;
-    desktopFolders << QString("/usr/share/applications/")
-                   << QString("/usr/local/share/applications/")
-                   << QString("/usr/share/gnome/applications/")
-                   << QString("/var/lib/flatpak/exports/share/applications")
-                   << QDir::homePath() + QString("/.local/share/flatpak/exports/share/applications")
-                   << QDir::homePath() + QString( "/.local/share/applications" );
-    return desktopFolders;
+    QStringList paths = QStandardPaths::standardLocations(QStandardPaths::ApplicationsLocation);
+    qDebug() << "dde-file-manager getApplicationsFolders:" << paths;
+    return paths;
 }
 
 QString MimesAppsManager::getMimeAppsCacheFile()
-- 
2.26.2

