#!@stdenv_shell@ -e

source @dfInit@

set -euo pipefail

exe="@dfExe@"

# If we're switching back from dfhack to vanilla, cleanup all dfhack
# links so Dwarf Fortress doesn't autoload its leftover libdfhooks.so.
# Otherwise, populate them.
dfhack_files=(
  dfhack
  dfhack-run
  .dfhackrc
  libdfhooks.so
  dfhack-config/default
  dfhack-config/init
  hack/*
  stonesense/*
  *.init *.init-example
)

if [ "${exe##*/}" == dfhack ]; then
  for i in "${dfhack_files[@]}"; do
    if [ -e "$i" ]; then
      update_path "$i"
    else
      cleanup_path "$i"
    fi
  done
else
  for i in "${dfhack_files[@]}"; do
    cleanup_path "$i"
  done
fi

# Go!
cd "$NIXPKGS_DF_HOME" && exec "./$exe" "$@"
