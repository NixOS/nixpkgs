set -e

if [[ ${TMPDIR:-} == /run/user/* ]]; then
    # /run/user is usually a tmpfs in RAM, which may be too small
    # to store all downloaded dotnet packages
    # `TMPDIR` is used by `mktemp` below.
    unset TMPDIR
fi

tmp=$(mktemp -d)
trap 'rm -rf "$tmp"' EXIT

HOME=$tmp/.home
cd "$tmp"

phases="
    ${prePhases[*]:-}
    unpackPhase
    patchPhase
    ${preConfigurePhases[*]:-}
    configurePhase
" genericBuild

depsFile=$(realpath "${1:-@defaultDepsFile@}")
tmpFile="$tmp"/deps.nix
echo -e "# This file was automatically generated by passthru.fetch-deps.\n# Please dont edit it manually, your changes might get overwritten!\n" > "$tmpFile"
@nugetToNix@/bin/nuget-to-nix "$NUGET_PACKAGES" >> "$tmpFile"
mv "$tmpFile" "$depsFile"
echo "Succesfully wrote lockfile to $depsFile"
