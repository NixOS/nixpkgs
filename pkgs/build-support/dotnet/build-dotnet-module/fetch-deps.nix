{ lib
, buildDotnetModule
, nuget-to-nix

, src
, name
, meta
, dotnet-sdk
, projectFile
, testProjectFile
, dotnetFlags
, dotnetRestoreFlags
, enableParallelBuilding
} @ args:

buildDotnetModule rec {
  name = "${args.name}-nuget-lockfile";
  dontDotnetSetNugetSource = true;
  dontDotnetFixup = true;

  inherit src dotnet-sdk projectFile testProjectFile dotnetFlags dotnetRestoreFlags enableParallelBuilding;

  preConfigure = ''
    export PACKAGE_DIR=$(mktemp -d)

    dotnetRestoreFlags+=(
      --packages "$PACKAGE_DIR/nuget_pkgs"
    )
  '';

  buildPhase = ''
    runHook preBuild
    deps_file="$PACKAGE_DIR/deps.nix"

    echo "Writing lockfile..."
    ${nuget-to-nix}/bin/nuget-to-nix "$PACKAGE_DIR/nuget_pkgs" > "$deps_file"

    runHook postBuild
  '';

  installPhase = ''
    runHook preInstall

    echo "# This file was automatically generated by \"nix-build -A attrpath.passthru.fetch-deps-impure --option sandbox false\". Please do not manually modify it, your changes might get overwritten.

    $(cat ''${deps_file})" > $out

    runHook postInstall
  '';

  meta = {
    description = "A lockfile containing the Nuget dependencies for ${name}";
  } // args.meta;
}
