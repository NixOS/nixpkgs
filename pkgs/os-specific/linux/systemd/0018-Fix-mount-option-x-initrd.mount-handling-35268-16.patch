From 030cb8e94b877d5be3274ec4a01f112f85187fb2 Mon Sep 17 00:00:00 2001
From: Timofei Kushnir <timophey@rdp.ru>
Date: Fri, 2 Mar 2018 13:02:53 +0300
Subject: [PATCH 18/24] Fix mount option `x-initrd.mount` handling (#35268)
 (#16)

---
 src/core/mount.c | 18 ++++--------------
 1 file changed, 4 insertions(+), 14 deletions(-)

diff --git a/src/core/mount.c b/src/core/mount.c
index 5e4c4a9767..6bc3569550 100644
--- a/src/core/mount.c
+++ b/src/core/mount.c
@@ -441,20 +441,10 @@ static int mount_add_default_dependencies(Mount *m) {
         if (!UNIT(m)->default_dependencies)
                 return 0;
 
-        if (!MANAGER_IS_SYSTEM(UNIT(m)->manager))
-                return 0;
-
-        /* We do not add any default dependencies to /, /usr or
-         * /run/initramfs/, since they are guaranteed to stay
-         * mounted the whole time, since our system is on it.
-         * Also, don't bother with anything mounted below virtual
-         * file systems, it's also going to be virtual, and hence
-         * not worth the effort. */
-        if (PATH_IN_SET(m->where, "/", "/usr", "/nix", "/nix/store") ||
-            path_startswith(m->where, "/run/initramfs") ||
-            path_startswith(m->where, "/proc") ||
-            path_startswith(m->where, "/sys") ||
-            path_startswith(m->where, "/dev"))
+        /* We do not add any default dependencies to /, /usr or /run/initramfs/, since they are guaranteed to stay
+         * mounted the whole time, since our system is on it.  Also, don't bother with anything mounted below virtual
+         * file systems, it's also going to be virtual, and hence not worth the effort. */
+        if (mount_is_extrinsic(m))
                 return 0;
 
         p = get_mount_parameters(m);
-- 
2.23.0

