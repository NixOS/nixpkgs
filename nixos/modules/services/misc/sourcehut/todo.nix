{ config, lib, pkgs, ... }:

with lib;

let
  cfg = config.services.sourcehut;
  tcfg = cfg.todo;
in {
  options = {
    services.sourcehut.todo = {
      notifyFrom = mkOption {
        type = types.str;
        default = "";
        description = ''
          Outgoing email for notifications generated by users.
        '';
      };
    };
  };

  config = mkIf tcfg.enable {
    users = {
      users = [
        { name = tcfg.user;
          group = tcfg.user;
          description = "todo.sr.ht user"; } ];

      groups = [
        { name = tcfg.user; } ];
    };

    systemd.services = {
      "todo.sr.ht" = {
        after = [ "postgresql.service" "network.target" ];
        requires = [ "postgresql.service" ];
        wantedBy = [ "multi-user.target" ];

        description = "todo.sr.ht website service";

        script = ''
          gunicorn todosrht.app:app \
            -b ${cfg.address}:${toString tcfg.port}
        '';
      };
    };
  };
}
