<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="sec-systemd-environment">
  <title>Environment and secret maangement</title>
  <para>
    The <literal>environment</literal> attribute is used to pass
    environment variables to the systemd service.
  </para>
  <programlisting>
environment = {
  MY_ENV_VAR = &quot;Something blue&quot;;
}
</programlisting>
  <para>
    A file can be passed as well with
    <literal>environmentFile</literal>. If both are passed,
    <literal>environmentFile</literal> takes precedence over
    <literal>environment</literal>
  </para>
  <para>
    Environment variables should not contain secret data. The main
    reason being that environment variables are accessible to
    unpriviledged users. See
    <link xlink:href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#Environment=">systemd
    doc</link> for a more detailed explanation.
  </para>
  <section xml:id="sec-systemd-secrets">
    <title>Secret management</title>
    <para>
      To pass secret data to a systemd service, systemd has the
      <literal>LoadCredential</literal> mechanism. By passing a file
      path to systemd, it will make sure that the file is available to
      the process under a specific path. The load credential attribute
      takes an id a colon and a file path letâ€™s have a look at an
      <link xlink:href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/web-apps/lemmy.nix#L182">example</link>
    </para>
    <programlisting>
LoadCredential = &quot;jwt_secret:${cfg.jwtSecretPath}&quot;;
</programlisting>
    <para>
      Inside your application, the jwt secret will be available under
      <literal>$CREDENTIALS_DIRECTORY/jwt_secret</literal> environment
      variable.
    </para>
    <para>
      Note that this requires your application to read secrets from a
      file.
    </para>
    <para>
      If your service can only read secrets through environment
      variables, the best alternative is to ask the end user to pass an
      <literal>environmentFile</literal> containing the secrets.
    </para>
    <para>
      If your service reads secrets from a configuration file, you can
      use the <literal>script</literal> attribute of your systemd
      service to populate that file with the secrets before starting the
      service.
      <link xlink:href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/web-apps/lemmy.nix#L172">example
      in nixpkgs</link>
    </para>
  </section>
</section>
