#!/usr/bin/env nix-shell
#!nix-shell -p bash nix-prefetch-github -i bash

# script to generate `pkgs/misc/emulators/dolphin-emu/default.nix`

set -e
exec >${1:?usage: $0 <output-file>}

# this has to be a valid commit for this update channel, i picked this as a random outdated beta
# (all betas are also valid dev builds)
base_commit="15fc71cfcf5f94221443aaff99ae559fa3cb4633"

# only stable releases have linux builds
# but we just want a commit hash, so the platform doesn't matter
updater_platform="win"

cat <<EOF
{ callPackage, darwin, qt5 }:
# Generated by /maintainers/scripts/update-dolphin
{
EOF

for branch in beta dev; do
    json=$(curl "https://dolphin-emu.org/update/check/v1/${branch}/${base_commit}/${updater_platform}")
    rev="$(echo "$json" | grep -oP '"new": {"hash": "\K[a-f0-9]*')"
    version="$(echo "$json" | grep -oP '"new": {.*"name": "\K[^"]*')"
    prefetch="$(nix-prefetch-github --rev "$rev" dolphin-emu dolphin)"
    sha256="$(echo "$prefetch" | grep -oP '"sha256": "\K[a-z0-9]*')"
    echo "  ${branch} = qt5.callPackage ./base.nix rec {"
    echo "    inherit (darwin.apple_sdk.frameworks) CoreBluetooth ForceFeedback IOKit OpenGL;"
    echo "    version = \"${version}\";"
    echo "    rev = \"${rev}\";"
    echo "    sha256 = \"${sha256}\";"
    echo "    branch = \"${branch}\";"
    echo "  };"
done

echo "  stable = callPackage ./stable.nix {};"
echo "}"

# vi: set ft=sh:
