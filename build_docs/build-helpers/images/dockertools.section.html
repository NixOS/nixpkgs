
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The operating system for autonomous systems">
      
      
      
        <link rel="canonical" href="https://github.com/nervosys/Botnix/build-helpers/images/dockertools.section.html">
      
      
        <link rel="prev" href="binarycache.section.html">
      
      
        <link rel="next" href="makediskimage.section.html">
      
      
      <link rel="icon" href="../../media/images/rune.svg">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.7">
    
    
      
        <title>pkgs.dockerTools - Botnix</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.f2e4d321.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
        <script src="https://unpkg.com/iframe-worker/shim"></script>
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sec-pkgs-dockerTools" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="Botnix" class="md-header__button md-logo" aria-label="Botnix" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Botnix
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              pkgs.dockerTools
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="nervosys" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/nervosys/Botnix" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    nervosys/Botnix
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="Botnix" class="md-nav__button md-logo" aria-label="Botnix" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5Z"/></svg>

    </a>
    Botnix
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/nervosys/Botnix" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    nervosys/Botnix
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../build-helpers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Build helpers
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing to Nixpkgs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Development of Nixpkgs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Functions reference
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lib.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nixpkgs lib
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../preface.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preface
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../stdenv.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Standard environment
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using-nixpkgs.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Nixpkgs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Build helpers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Build helpers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fetchers.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fetchers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../images.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Images
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../special.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Special build helpers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../testers.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trivial-build-helpers.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Trivial build helpers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_6" checked>
        
          
          <label class="md-nav__link" for="__nav_10_6" id="__nav_10_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Images
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10_6">
            <span class="md-nav__icon md-icon"></span>
            Images
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="appimagetools.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pkgs.appimageTools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="binarycache.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pkgs.mkBinaryCache
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    pkgs.dockerTools
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="dockertools.section.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    pkgs.dockerTools
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ssec-pkgs-dockerTools-buildImage" class="md-nav__link">
    <span class="md-ellipsis">
      buildImage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="buildImage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ssec-pkgs-dockerTools-buildImage-inputs" class="md-nav__link">
    <span class="md-ellipsis">
      Inputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssec-pkgs-dockerTools-buildImage-passthru-outputs" class="md-nav__link">
    <span class="md-ellipsis">
      Passthru outputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssec-pkgs-dockerTools-buildImage-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="makediskimage.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    &lt;nixpkgs/nixos/lib/make-disk-image.nix&gt;
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ocitools.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pkgs.ociTools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="portableservice.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pkgs.portableService
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="snaptools.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pkgs.snapTools
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_7" >
        
          
          <label class="md-nav__link" for="__nav_10_7" id="__nav_10_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Special
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_7">
            <span class="md-nav__icon md-icon"></span>
            Special
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../special/checkpoint-build.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pkgs.checkpointBuildTools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../special/fakenss.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fakeNss
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../special/fhs-environments.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    buildFHSEnv
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../special/makesetuphook.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pkgs.makeSetupHook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../special/mkshell.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pkgs.mkShell
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../special/vm-tools.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vmTools
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Contributing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/coding-conventions.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Coding conventions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/contributing-to-documentation.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing to Nixpkgs documentation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/quick-start.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Start to Adding a Package
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/reviewing-contributions.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reviewing contributions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/submitting-changes.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Submitting changes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/vulnerability-roundup.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vulnerability Roundup
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Development
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/opening-issues.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Opening issues
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Functions
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Functions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functions/debug.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Debugging Nix Expressions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functions/generators.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Generators
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functions/nix-gitignore.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pkgs.nix-gitignore
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functions/prefer-remote-fetch.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    prefer-remote-fetch overlay
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Hooks
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            Hooks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hooks reference
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/autoconf.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Autoconf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/automake.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automake
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/autopatchelf.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    autoPatchelfHook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/bmake.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bmake
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/breakpoint.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    breakpointHook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/cmake.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cmake
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/gdk-pixbuf.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gdk-pixbuf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/ghc.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GHC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/gnome.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GNOME platform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/installShellFiles.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    installShellFiles
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/libiconv.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    libiconv, libintl
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/libxml2.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    libxml2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/meson.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meson
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/mpi-check-hook.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mpiCheckPhaseHook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/ninja.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ninja
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/patch-rc-path-hooks.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    patchRcPath hooks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/perl.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Perl
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/pkg-config.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pkg-config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/postgresql-test-hook.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    postgresqlTestHook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/python.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/scons.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    scons
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/tetex-tex-live.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    teTeX / TeX Live
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/unzip.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    unzip
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/validatePkgConfig.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    validatePkgConfig
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/waf.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    wafHook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/xcbuild.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    xcbuildHook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hooks/zig.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zig.hook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Languages frameworks
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            Languages frameworks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Languages and frameworks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/agda.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Agda
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/android.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/beam.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BEAM Languages (Erlang, Elixir & LFE)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/bower.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bower
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/chicken.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CHICKEN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/coq.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Coq and coq packages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/crystal.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Crystal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/cuda.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CUDA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/cuelang.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cue (Cuelang)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/dart.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dart
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/dhall.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dhall
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/dotnet.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dotnet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/emscripten.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Emscripten
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/gnome.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GNOME
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/go.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Go
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/haskell.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Haskell
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/hy.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/idris.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Idris
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/idris2.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Idris2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/ios.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    iOS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/java.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/javascript.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Javascript
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/julia.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Julia
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/lisp.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lisp-modules
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/lua.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Userâ€™s Guide to Lua Infrastructure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/maven.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Maven
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/nim.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nim
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/ocaml.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OCaml
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/octave.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Octave
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/perl.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Perl
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/php.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PHP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/pkg-config.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pkg-config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/python.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/qt.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Qt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/r.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    R
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/ruby.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ruby
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/rust.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/swift.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Swift
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/texlive.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TeX Live
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/titanium.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Titanium
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../languages-frameworks/vim.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vim
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
        
          
          <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Module system
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_16">
            <span class="md-nav__icon md-icon"></span>
            Module system
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../module-system/module-system.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Module System
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" >
        
          
          <label class="md-nav__link" for="__nav_17" id="__nav_17_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Packages
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_17">
            <span class="md-nav__icon md-icon"></span>
            Packages
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Packages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/cataclysm-dda.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cataclysm: Dark Days Ahead
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/citrix.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Citrix Workspace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/darwin-builder.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    darwin.linux-builder
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/dlib.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DLib
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/eclipse.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Eclipse
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/elm.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/emacs.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Emacs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/etc-files.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    /etc files
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/firefox.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Firefox
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/fish.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fish
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/fuse.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FUSE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/ibus.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ibus-engines.typing-booster
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/kakoune.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kakoune
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/linux.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux kernel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/locales.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Locales
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/nginx.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nginx
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/opengl.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OpenGL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/shell-helpers.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interactive shell helpers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/steam.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Steam
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/urxvt.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Urxvt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/weechat.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WeeChat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/xorg.section.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    X.org
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_18" >
        
          
          <label class="md-nav__link" for="__nav_18" id="__nav_18_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Stdenv
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_18_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_18">
            <span class="md-nav__icon md-icon"></span>
            Stdenv
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../stdenv/cross-compilation.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cross-compilation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../stdenv/meta.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meta-attributes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../stdenv/multiple-output.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multiple-output packages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../stdenv/platform-notes.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Platform Notes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../stdenv/stdenv.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The Standard Environment
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_19" >
        
          
          <label class="md-nav__link" for="__nav_19" id="__nav_19_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Using
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_19_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_19">
            <span class="md-nav__icon md-icon"></span>
            Using
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using/configuration.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Global configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using/overlays.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overlays
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using/overrides.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overriding
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using/platform-support.chapter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Platform Support
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="sec-pkgs-dockerTools">pkgs.dockerTools<a class="headerlink" href="#sec-pkgs-dockerTools" title="Permanent link">#</a></h1>
<p><code>pkgs.dockerTools</code> is a set of functions for creating and manipulating Docker images according to the <a href="https://github.com/moby/moby/blob/46f7ab808b9504d735d600e259ca0723f76fb164/image/spec/spec.md#image-json-field-descriptions">Docker Image Specification v1.3.0</a>.
Docker itself is not used to perform any of the operations done by these functions.</p>
<h2 id="ssec-pkgs-dockerTools-buildImage">buildImage<a class="headerlink" href="#ssec-pkgs-dockerTools-buildImage" title="Permanent link">#</a></h2>
<p>This function builds a Docker-compatible repository tarball containing a single image.
As such, the result is suitable for being loaded in Docker with <code>docker load</code> (see <a href="#ex-dockerTools-buildImage"></a> for how to do this).</p>
<p>This function will create a single layer for all files (and dependencies) that are specified in its argument.
Only new dependencies that are not already in the existing layers will be copied.
If you prefer to create multiple layers for the files and dependencies you want to add to the image, see <a href="#ssec-pkgs-dockerTools-buildLayeredImage"></a> or <a href="#ssec-pkgs-dockerTools-streamLayeredImage"></a> instead.</p>
<p>This function allows a script to be run during the layer generation process, allowing custom behaviour to affect the final results of the image (see the documentation of the <code>runAsRoot</code> and <code>extraCommands</code> attributes).</p>
<p>The resulting repository tarball will list a single image as specified by the <code>name</code> and <code>tag</code> attributes.
By default, that image will use a static creation date (see documentation for the <code>created</code> attribute).
This allows <code>buildImage</code> to produce reproducible images.</p>
<p>:::{.tip}
When running an image built with <code>buildImage</code>, you might encounter certain errors depending on what you included in the image, especially if you did not start with any base image.</p>
<p>If you encounter errors similar to <code>getProtocolByName: does not exist (no such protocol name: tcp)</code>, you may need to add the contents of <code>pkgs.iana-etc</code> in the <code>copyToRoot</code> attribute.
Similarly, if you encounter errors similar to <code>Error_Protocol ("certificate has unknown CA",True,UnknownCa)</code>, you may need to add the contents of <code>pkgs.cacert</code> in the <code>copyToRoot</code> attribute.
:::</p>
<h3 id="ssec-pkgs-dockerTools-buildImage-inputs">Inputs<a class="headerlink" href="#ssec-pkgs-dockerTools-buildImage-inputs" title="Permanent link">#</a></h3>
<p><code>buildImage</code> expects an argument with the following attributes:</p>
<p><code>name</code> (String)</p>
<p>: The name of the generated image.</p>
<p><code>tag</code> (String or Null; <em>optional</em>)</p>
<p>: Tag of the generated image.
  If <code>null</code>, the hash of the nix derivation will be used as the tag.</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>fromImage</code> (Path or Null; <em>optional</em>)</p>
<p>: The repository tarball of an image to be used as the base for the generated image.
  It must be a valid Docker image, such as one exported by <code>docker save</code>, or another image built with the <code>dockerTools</code> utility functions.
  This can be seen as an equivalent of <code>FROM fromImage</code> in a <code>Dockerfile</code>.
  A value of <code>null</code> can be seen as an equivalent of <code>FROM scratch</code>.</p>
<p>If specified, the layer created by <code>buildImage</code> will be appended to the layers defined in the base image, resulting in an image with at least two layers (one or more layers from the base image, and the layer created by <code>buildImage</code>).
  Otherwise, the resulting image with contain the single layer created by <code>buildImage</code>.</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>fromImageName</code> (String or Null; <em>optional</em>)</p>
<p>: Used to specify the image within the repository tarball in case it contains multiple images.
  A value of <code>null</code> means that <code>buildImage</code> will use the first image available in the repository.</p>
<p>:::{.note}
  This must be used with <code>fromImageTag</code>. Using only <code>fromImageName</code> without <code>fromImageTag</code> will make <code>buildImage</code> use the first image available in the repository.
  :::</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>fromImageTag</code> (String or Null; <em>optional</em>)</p>
<p>: Used to specify the image within the repository tarball in case it contains multiple images.
  A value of <code>null</code> means that <code>buildImage</code> will use the first image available in the repository.</p>
<p>:::{.note}
  This must be used with <code>fromImageName</code>. Using only <code>fromImageTag</code> without <code>fromImageName</code> will make <code>buildImage</code> use the first image available in the repository
  :::</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>copyToRoot</code> (Path, List of Paths, or Null; <em>optional</em>)</p>
<p>: Files to add to the generated image.
  Anything that coerces to a path (e.g. a derivation) can also be used.
  This can be seen as an equivalent of <code>ADD contents/ /</code> in a <code>Dockerfile</code>.</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>keepContentsDirlinks</code> (Boolean; <em>optional</em>)</p>
<p>: When adding files to the generated image (as specified by <code>copyToRoot</code>), this attribute controls whether to preserve symlinks to directories.
  If <code>false</code>, the symlinks will be transformed into directories.
  This behaves the same as <code>rsync -k</code> when <code>keepContentsDirlinks</code> is <code>false</code>, and the same as <code>rsync -K</code> when <code>keepContentsDirlinks</code> is <code>true</code>.</p>
<p><em>Default value:</em> <code>false</code>.</p>
<p><code>runAsRoot</code> (String or Null; <em>optional</em>)</p>
<p>: A bash script that will run as root inside a VM that contains the existing layers of the base image and the new generated layer (including the files from <code>copyToRoot</code>).
  The script will be run with a working directory of <code>/</code>.
  This can be seen as an equivalent of <code>RUN ...</code> in a <code>Dockerfile</code>.
  A value of <code>null</code> means that this step in the image generation process will be skipped.</p>
<p>See <a href="#ex-dockerTools-buildImage-runAsRoot"></a> for how to work with this attribute.</p>
<p>:::{.caution}
  Using this attribute requires the <code>kvm</code> device to be available, see <a href="https://nixos.org/manual/nix/stable/command-ref/conf-file.html#conf-system-features"><code>system-features</code></a>.
  If the <code>kvm</code> device isn't available, you should consider using <a href="#ssec-pkgs-dockerTools-buildLayeredImage"><code>buildLayeredImage</code></a> or <a href="#ssec-pkgs-dockerTools-streamLayeredImage"><code>streamLayeredImage</code></a> instead.
  Those functions allow scripts to be run as root without access to the <code>kvm</code> device.
  :::</p>
<p>:::{.note}
  At the time the script in <code>runAsRoot</code> is run, the files specified directly in <code>copyToRoot</code> will be present in the VM, but their dependencies might not be there yet.
  Copying their dependencies into the generated image is a step that happens after <code>runAsRoot</code> finishes running.
  :::</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>extraCommands</code> (String; <em>optional</em>)</p>
<p>: A bash script that will run before the layer created by <code>buildImage</code> is finalised.
  The script will be run on some (opaque) working directory which will become <code>/</code> once the layer is created.
  This is similar to <code>runAsRoot</code>, but the script specified in <code>extraCommands</code> is <strong>not</strong> run as root, and does not involve creating a VM.
  It is simply run as part of building the derivation that outputs the layer created by <code>buildImage</code>.</p>
<p>See <a href="#ex-dockerTools-buildImage-extraCommands"></a> for how to work with this attribute, and subtle differences compared to <code>runAsRoot</code>.</p>
<p><em>Default value:</em> <code>""</code>.</p>
<p><code>config</code> (Attribute Set; <em>optional</em>)</p>
<p>: Used to specify the configuration of the containers that will be started off the generated image.
  Must be an attribute set, with each attribute as listed in the <a href="https://github.com/moby/moby/blob/46f7ab808b9504d735d600e259ca0723f76fb164/image/spec/spec.md#image-json-field-descriptions">Docker Image Specification v1.3.0</a>.</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>architecture</code> (String; <em>optional</em>)</p>
<p>: Used to specify the image architecture.
  This is useful for multi-architecture builds that don't need cross compiling.
  If specified, its value should follow the <a href="https://github.com/opencontainers/image-spec/blob/main/config.md#properties">OCI Image Configuration Specification</a>, which should still be compatible with Docker.
  According to the linked specification, all possible values for <code>$GOARCH</code> in <a href="https://go.dev/doc/install/source#environment">the Go docs</a> should be valid, but will commonly be one of <code>386</code>, <code>amd64</code>, <code>arm</code>, or <code>arm64</code>.</p>
<p><em>Default value:</em> the same value from <code>pkgs.go.GOARCH</code>.</p>
<p><code>diskSize</code> (Number; <em>optional</em>)</p>
<p>: Controls the disk size (in megabytes) of the VM used to run the script specified in <code>runAsRoot</code>.
  This attribute is ignored if <code>runAsRoot</code> is <code>null</code>.</p>
<p><em>Default value:</em> 1024.</p>
<p><code>buildVMMemorySize</code> (Number; <em>optional</em>)</p>
<p>: Controls the amount of memory (in megabytes) provisioned for the VM used to run the script specified in <code>runAsRoot</code>.
  This attribute is ignored if <code>runAsRoot</code> is <code>null</code>.</p>
<p><em>Default value:</em> 512.</p>
<p><code>created</code> (String; <em>optional</em>)</p>
<p>: Specifies the time of creation of the generated image.
  This should be either a date and time formatted according to <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO-8601</a> or <code>"now"</code>, in which case <code>buildImage</code> will use the current date.</p>
<p>See <a href="#ex-dockerTools-buildImage-creatednow"></a> for how to use <code>"now"</code>.</p>
<p>:::{.caution}
  Using <code>"now"</code> means that the generated image will not be reproducible anymore (because the date will always change whenever it's built).
  :::</p>
<p><em>Default value:</em> <code>"1970-01-01T00:00:01Z"</code>.</p>
<p><code>uid</code> (Number; <em>optional</em>)</p>
<p>: The uid of the user that will own the files packed in the new layer built by <code>buildImage</code>.</p>
<p><em>Default value:</em> 0.</p>
<p><code>gid</code> (Number; <em>optional</em>)</p>
<p>: The gid of the group that will own the files packed in the new layer built by <code>buildImage</code>.</p>
<p><em>Default value:</em> 0.</p>
<p><code>contents</code> <strong>DEPRECATED</strong></p>
<p>: This attribute is deprecated, and users are encouraged to use <code>copyToRoot</code> instead.</p>
<h3 id="ssec-pkgs-dockerTools-buildImage-passthru-outputs">Passthru outputs<a class="headerlink" href="#ssec-pkgs-dockerTools-buildImage-passthru-outputs" title="Permanent link">#</a></h3>
<p><code>buildImage</code> defines a few <a href="#var-stdenv-passthru"><code>passthru</code></a> attributes:</p>
<p><code>buildArgs</code> (Attribute Set)</p>
<p>: The argument passed to <code>buildImage</code> itself.
  This allows you to inspect all attributes specified in the argument, as described above.</p>
<p><code>layer</code> (Attribute Set)</p>
<p>: The derivation with the layer created by <code>buildImage</code>.
  This allows easier inspection of the contents added by <code>buildImage</code> in the generated image.</p>
<p><code>imageTag</code> (String)</p>
<p>: The tag of the generated image.
  This is useful if no tag was specified in the attributes of the argument to <code>buildImage</code>, because an automatic tag will be used instead.
  <code>imageTag</code> allows you to retrieve the value of the tag used in this case.</p>
<h3 id="ssec-pkgs-dockerTools-buildImage-examples">Examples<a class="headerlink" href="#ssec-pkgs-dockerTools-buildImage-examples" title="Permanent link">#</a></h3>
<p>:::{.example #ex-dockerTools-buildImage}</p>
<h1 id="building-a-docker-image">Building a Docker image<a class="headerlink" href="#building-a-docker-image" title="Permanent link">#</a></h1>
<p>The following package builds a Docker image that runs the <code>redis-server</code> executable from the <code>redis</code> package.
The Docker image will have name <code>redis</code> and tag <code>latest</code>.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> buildEnv<span class="p">,</span> redis <span class="p">}:</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>dockerTools<span class="o">.</span>buildImage <span class="p">{</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;redis&quot;</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>  <span class="ss">copyToRoot</span> <span class="o">=</span> buildEnv <span class="p">{</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;image-root&quot;</span><span class="p">;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="ss">paths</span> <span class="o">=</span> <span class="p">[</span> redis <span class="p">];</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="ss">pathsToLink</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin&quot;</span> <span class="p">];</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>  <span class="p">};</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>  <span class="ss">runAsRoot</span> <span class="o">=</span> <span class="s s-Multiline">&#39;&#39;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="s s-Multiline">    mkdir -p /data</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="s s-Multiline">  &#39;&#39;</span><span class="p">;</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>  <span class="ss">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="ss">Cmd</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin/redis-server&quot;</span> <span class="p">];</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="ss">WorkingDir</span> <span class="o">=</span> <span class="s2">&quot;/data&quot;</span><span class="p">;</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="ss">Volumes</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;/data&quot;</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span> <span class="p">};</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>  <span class="p">};</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="p">}</span>
</span></code></pre></div>
<p>The result of building this package is a <code>.tar.gz</code> file that can be loaded into Docker:</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>building<span class="w"> </span><span class="s1">&#39;/nix/store/yw0adm4wpsw1w6j4fb5hy25b3arr9s1v-docker-image-redis.tar.gz.drv&#39;</span>...
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>Adding<span class="w"> </span>layer...
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>tar:<span class="w"> </span>Removing<span class="w"> </span>leading<span class="w"> </span><span class="sb">`</span>/<span class="err">&#39;</span><span class="w"> </span>from<span class="w"> </span>member<span class="w"> </span>names
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>Adding<span class="w"> </span>meta...
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>Cooking<span class="w"> </span>the<span class="w"> </span>image...
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>Finished.
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>/nix/store/p4dsg62inh9d2ksy3c7bv58xa851dasr-docker-image-redis.tar.gz
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>$<span class="w"> </span>docker<span class="w"> </span>load<span class="w"> </span>-i<span class="w"> </span>/nix/store/p4dsg62inh9d2ksy3c7bv58xa851dasr-docker-image-redis.tar.gz
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>Loaded<span class="w"> </span>image:<span class="w"> </span>redis:latest
</span></code></pre></div>
:::</p>
<p>:::{.example #ex-dockerTools-buildImage-runAsRoot}</p>
<h1 id="building-a-docker-image-with-runasroot">Building a Docker image with <code>runAsRoot</code><a class="headerlink" href="#building-a-docker-image-with-runasroot" title="Permanent link">#</a></h1>
<p>The following package builds a Docker image with the <code>hello</code> executable from the <code>hello</code> package.
It uses <code>runAsRoot</code> to create a directory and a file inside the image.</p>
<p>This works the same as <a href="#ex-dockerTools-buildImage-extraCommands"></a>, but uses <code>runAsRoot</code> instead of <code>extraCommands</code>.</p>
<p><div class="language-nix highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> buildEnv<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>dockerTools<span class="o">.</span>buildImage <span class="p">{</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>  <span class="ss">copyToRoot</span> <span class="o">=</span> buildEnv <span class="p">{</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;image-root&quot;</span><span class="p">;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="ss">paths</span> <span class="o">=</span> <span class="p">[</span> hello <span class="p">];</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="ss">pathsToLink</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin&quot;</span> <span class="p">];</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>  <span class="p">};</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>  <span class="ss">runAsRoot</span> <span class="o">=</span> <span class="s s-Multiline">&#39;&#39;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="s s-Multiline">    mkdir -p /data</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="s s-Multiline">    echo &quot;some content&quot; &gt; my-file</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="s s-Multiline">  &#39;&#39;</span><span class="p">;</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>  <span class="ss">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="ss">Cmd</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin/hello&quot;</span> <span class="p">];</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>    <span class="ss">WorkingDir</span> <span class="o">=</span> <span class="s2">&quot;/data&quot;</span><span class="p">;</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>  <span class="p">};</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="p">}</span>
</span></code></pre></div>
:::</p>
<p>:::{.example #ex-dockerTools-buildImage-extraCommands}</p>
<h1 id="building-a-docker-image-with-extracommands">Building a Docker image with <code>extraCommands</code><a class="headerlink" href="#building-a-docker-image-with-extracommands" title="Permanent link">#</a></h1>
<p>The following package builds a Docker image with the <code>hello</code> executable from the <code>hello</code> package.
It uses <code>extraCommands</code> to create a directory and a file inside the image.</p>
<p>This works the same as <a href="#ex-dockerTools-buildImage-runAsRoot"></a>, but uses <code>extraCommands</code> instead of <code>runAsRoot</code>.
Note that with <code>extraCommands</code>, we can't directly reference <code>/</code> and must create files and directories as if we were already on <code>/</code>.</p>
<p><div class="language-nix highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> buildEnv<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>dockerTools<span class="o">.</span>buildImage <span class="p">{</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>  <span class="ss">copyToRoot</span> <span class="o">=</span> buildEnv <span class="p">{</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;image-root&quot;</span><span class="p">;</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>    <span class="ss">paths</span> <span class="o">=</span> <span class="p">[</span> hello <span class="p">];</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="ss">pathsToLink</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin&quot;</span> <span class="p">];</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>  <span class="p">};</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>  <span class="ss">extraCommands</span> <span class="o">=</span> <span class="s s-Multiline">&#39;&#39;</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="s s-Multiline">    mkdir -p data</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="s s-Multiline">    echo &quot;some content&quot; &gt; my-file</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="s s-Multiline">  &#39;&#39;</span><span class="p">;</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>  <span class="ss">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    <span class="ss">Cmd</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin/hello&quot;</span> <span class="p">];</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>    <span class="ss">WorkingDir</span> <span class="o">=</span> <span class="s2">&quot;/data&quot;</span><span class="p">;</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>  <span class="p">};</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="p">}</span>
</span></code></pre></div>
:::</p>
<p>:::{.example #ex-dockerTools-buildImage-creatednow}</p>
<h1 id="building-a-docker-image-with-a-creation-date-set-to-the-current-time">Building a Docker image with a creation date set to the current time<a class="headerlink" href="#building-a-docker-image-with-a-creation-date-set-to-the-current-time" title="Permanent link">#</a></h1>
<p>Note that using a value of <code>"now"</code> in the <code>created</code> attribute will break reproducibility.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> buildEnv<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>dockerTools<span class="o">.</span>buildImage <span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>  <span class="ss">created</span> <span class="o">=</span> <span class="s2">&quot;now&quot;</span><span class="p">;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>  <span class="ss">copyToRoot</span> <span class="o">=</span> buildEnv <span class="p">{</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;image-root&quot;</span><span class="p">;</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="ss">paths</span> <span class="o">=</span> <span class="p">[</span> hello <span class="p">];</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="ss">pathsToLink</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin&quot;</span> <span class="p">];</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>  <span class="p">};</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>  config<span class="o">.</span><span class="ss">Cmd</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin/hello&quot;</span> <span class="p">];</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="p">}</span>
</span></code></pre></div>
<p>After importing the generated repository tarball with Docker, its CLI will display a reasonable date and sort the images as expected:</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>$ docker images
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>REPOSITORY   TAG      IMAGE ID       CREATED              SIZE
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>hello        latest   de2bf4786de6   About a minute ago   25.2MB
</span></code></pre></div>
:::</p>
<h2 id="ssec-pkgs-dockerTools-buildLayeredImage">buildLayeredImage<a class="headerlink" href="#ssec-pkgs-dockerTools-buildLayeredImage" title="Permanent link">#</a></h2>
<p><code>buildLayeredImage</code> uses <a href="#ssec-pkgs-dockerTools-streamLayeredImage"><code>streamLayeredImage</code></a> underneath to build a compressed Docker-compatible repository tarball.
Basically, <code>buildLayeredImage</code> runs the script created by <code>streamLayeredImage</code> to save the compressed image in the Nix store.
<code>buildLayeredImage</code> supports the same options as <code>streamLayeredImage</code>, see <a href="#ssec-pkgs-dockerTools-streamLayeredImage"><code>streamLayeredImage</code></a> for details.</p>
<p>:::{.note}
Despite the similar name, <a href="#ssec-pkgs-dockerTools-buildImage"><code>buildImage</code></a> works completely differently from <code>buildLayeredImage</code> and <code>streamLayeredImage</code>.</p>
<p>Even though some of the arguments may seem related, they cannot be interchanged.
:::</p>
<p>You can use this function to load an image in Docker with <code>docker load</code>.
See <a href="#ex-dockerTools-buildLayeredImage-hello"></a> to see how to do that.</p>
<h3 id="ssec-pkgs-dockerTools-buildLayeredImage-examples">Examples<a class="headerlink" href="#ssec-pkgs-dockerTools-buildLayeredImage-examples" title="Permanent link">#</a></h3>
<p>:::{.example #ex-dockerTools-buildLayeredImage-hello}</p>
<h1 id="building-a-layered-docker-image">Building a layered Docker image<a class="headerlink" href="#building-a-layered-docker-image" title="Permanent link">#</a></h1>
<p>The following package builds a layered Docker image that runs the <code>hello</code> executable from the <code>hello</code> package.
The Docker image will have name <code>hello</code> and tag <code>latest</code>.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>dockerTools<span class="o">.</span>buildLayeredImage <span class="p">{</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>  <span class="ss">contents</span> <span class="o">=</span> <span class="p">[</span> hello <span class="p">];</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>  config<span class="o">.</span><span class="ss">Cmd</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin/hello&quot;</span> <span class="p">];</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>The result of building this package is a <code>.tar.gz</code> file that can be loaded into Docker:</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>building<span class="w"> </span><span class="s1">&#39;/nix/store/bk8bnrbw10nq7p8pvcmdr0qf57y6scha-hello.tar.gz.drv&#39;</span>...
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>No<span class="w"> </span><span class="s1">&#39;fromImage&#39;</span><span class="w"> </span>provided
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>Creating<span class="w"> </span>layer<span class="w"> </span><span class="m">1</span><span class="w"> </span>from<span class="w"> </span>paths:<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/nix/store/i93s7xxblavsacpy82zdbn4kplsyq48l-libunistring-1.1&#39;</span><span class="o">]</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>Creating<span class="w"> </span>layer<span class="w"> </span><span class="m">2</span><span class="w"> </span>from<span class="w"> </span>paths:<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/nix/store/ji01n9vinnj22nbrb86nx8a1ssgpilx8-libidn2-2.3.4&#39;</span><span class="o">]</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>Creating<span class="w"> </span>layer<span class="w"> </span><span class="m">3</span><span class="w"> </span>from<span class="w"> </span>paths:<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/nix/store/ldrslljw4rg026nw06gyrdwl78k77vyq-xgcc-12.3.0-libgcc&#39;</span><span class="o">]</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>Creating<span class="w"> </span>layer<span class="w"> </span><span class="m">4</span><span class="w"> </span>from<span class="w"> </span>paths:<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/nix/store/9y8pmvk8gdwwznmkzxa6pwyah52xy3nk-glibc-2.38-27&#39;</span><span class="o">]</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>Creating<span class="w"> </span>layer<span class="w"> </span><span class="m">5</span><span class="w"> </span>from<span class="w"> </span>paths:<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1&#39;</span><span class="o">]</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>Creating<span class="w"> </span>layer<span class="w"> </span><span class="m">6</span><span class="w"> </span>with<span class="w"> </span>customisation...
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>Adding<span class="w"> </span>manifests...
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>Done.
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>/nix/store/hxcz7snvw7f8rzhbh6mv8jq39d992905-hello.tar.gz
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>$<span class="w"> </span>docker<span class="w"> </span>load<span class="w"> </span>-i<span class="w"> </span>/nix/store/hxcz7snvw7f8rzhbh6mv8jq39d992905-hello.tar.gz
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>Loaded<span class="w"> </span>image:<span class="w"> </span>hello:latest
</span></code></pre></div>
:::</p>
<h2 id="ssec-pkgs-dockerTools-streamLayeredImage">streamLayeredImage<a class="headerlink" href="#ssec-pkgs-dockerTools-streamLayeredImage" title="Permanent link">#</a></h2>
<p><code>streamLayeredImage</code> builds a <strong>script</strong> which, when run, will stream to stdout a Docker-compatible repository tarball containing a single image, using multiple layers to improve sharing between images.
This means that <code>streamLayeredImage</code> does not output an image into the Nix store, but only a script that builds the image, saving on IO and disk/cache space, particularly with large images.</p>
<p>You can use this function to load an image in Docker with <code>docker load</code>.
See <a href="#ex-dockerTools-streamLayeredImage-hello"></a> to see how to do that.</p>
<p>For this function, you specify a <a href="https://nixos.org/manual/nix/stable/store/store-path">store path</a> or a list of store paths to be added to the image, and the functions will automatically include any dependencies of those paths in the image.
The function will attempt to create one layer per object in the Nix store that needs to be added to the image.
In case there are more objects to include than available layers, the function will put the most <a href="https://github.com/NixOS/nixpkgs/tree/release-23.11/pkgs/build-support/references-by-popularity">"popular"</a> objects in their own layers, and group all remaining objects into a single layer.</p>
<p>An additional layer will be created with symlinks to the store paths you specified to be included in the image.
These symlinks are built with <a href="#trivial-builder-symlinkJoin"><code>symlinkJoin</code></a>, so they will be included in the root of the image.
See <a href="#ex-dockerTools-streamLayeredImage-exploringlayers"></a> to understand how these symlinks are laid out in the generated image.</p>
<p><code>streamLayeredImage</code> allows scripts to be run when creating the additional layer with symlinks, allowing custom behaviour to affect the final results of the image (see the documentation of the <code>extraCommands</code> and <code>fakeRootCommands</code> attributes).</p>
<p>The resulting repository tarball will list a single image as specified by the <code>name</code> and <code>tag</code> attributes.
By default, that image will use a static creation date (see documentation for the <code>created</code> attribute).
This allows the function to produce reproducible images.</p>
<h3 id="ssec-pkgs-dockerTools-streamLayeredImage-inputs">Inputs<a class="headerlink" href="#ssec-pkgs-dockerTools-streamLayeredImage-inputs" title="Permanent link">#</a></h3>
<p><code>streamLayeredImage</code> expects one argument with the following attributes:</p>
<p><code>name</code> (String)</p>
<p>: The name of the generated image.</p>
<p><code>tag</code> (String; <em>optional</em>)</p>
<p>: Tag of the generated image.
  If <code>null</code>, the hash of the nix derivation will be used as the tag.</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>fromImage</code>(Path or Null; <em>optional</em>)</p>
<p>: The repository tarball of an image to be used as the base for the generated image.
  It must be a valid Docker image, such as one exported by <code>docker save</code>, or another image built with the <code>dockerTools</code> utility functions.
  This can be seen as an equivalent of <code>FROM fromImage</code> in a <code>Dockerfile</code>.
  A value of <code>null</code> can be seen as an equivalent of <code>FROM scratch</code>.</p>
<p>If specified, the created layers will be appended to the layers defined in the base image.</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>contents</code> (Path or List of Paths; <em>optional</em>) []{#dockerTools-buildLayeredImage-arg-contents}</p>
<p>: Directories whose contents will be added to the generated image.
  Things that coerce to paths (e.g. a derivation) can also be used.
  This can be seen as an equivalent of <code>ADD contents/ /</code> in a <code>Dockerfile</code>.</p>
<p>All the contents specified by <code>contents</code> will be added as a final layer in the generated image.
  They will be added as links to the actual files (e.g. links to the store paths).
  The actual files will be added in previous layers.</p>
<p><em>Default value:</em> <code>[]</code></p>
<p><code>config</code> (Attribute Set; <em>optional</em>) []{#dockerTools-buildLayeredImage-arg-config}</p>
<p>: Used to specify the configuration of the containers that will be started off the generated image.
  Must be an attribute set, with each attribute as listed in the <a href="https://github.com/moby/moby/blob/46f7ab808b9504d735d600e259ca0723f76fb164/image/spec/spec.md#image-json-field-descriptions">Docker Image Specification v1.3.0</a>.</p>
<p>If any packages are used directly in <code>config</code>, they will be automatically included in the generated image.
  See <a href="#ex-dockerTools-streamLayeredImage-configclosure"></a> for an example.</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>architecture</code> (String; <em>optional</em>)</p>
<p>: Used to specify the image architecture.
  This is useful for multi-architecture builds that don't need cross compiling.
  If specified, its value should follow the <a href="https://github.com/opencontainers/image-spec/blob/main/config.md#properties">OCI Image Configuration Specification</a>, which should still be compatible with Docker.
  According to the linked specification, all possible values for <code>$GOARCH</code> in <a href="https://go.dev/doc/install/source#environment">the Go docs</a> should be valid, but will commonly be one of <code>386</code>, <code>amd64</code>, <code>arm</code>, or <code>arm64</code>.</p>
<p><em>Default value:</em> the same value from <code>pkgs.go.GOARCH</code>.</p>
<p><code>created</code> (String; <em>optional</em>)</p>
<p>: Specifies the time of creation of the generated image.
  This should be either a date and time formatted according to <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO-8601</a> or <code>"now"</code>, in which case the current date will be used.</p>
<p>:::{.caution}
  Using <code>"now"</code> means that the generated image will not be reproducible anymore (because the date will always change whenever it's built).
  :::</p>
<p><em>Default value:</em> <code>"1970-01-01T00:00:01Z"</code>.</p>
<p><code>maxLayers</code> (Number; <em>optional</em>) []{#dockerTools-buildLayeredImage-arg-maxLayers}</p>
<p>: The maximum number of layers that will be used by the generated image.
  If a <code>fromImage</code> was specified, the number of layers used by <code>fromImage</code> will be subtracted from <code>maxLayers</code> to ensure that the image generated will have at most <code>maxLayers</code>.</p>
<p>:::{.caution}
  Depending on the tool/runtime where the image will be used, there might be a limit to the number of layers that an image can have.
  For Docker, see <a href="https://github.com/docker/docs/issues/8230">this issue on GitHub</a>.
  :::</p>
<p><em>Default value:</em> 100.</p>
<p><code>extraCommands</code> (String; <em>optional</em>)</p>
<p>: A bash script that will run in the context of the layer created with the contents specified by <code>contents</code>.
  At the moment this script runs, only the contents directly specified by <code>contents</code> will be available as links.</p>
<p><em>Default value:</em> <code>""</code>.</p>
<p><code>fakeRootCommands</code> (String; <em>optional</em>)</p>
<p>: A bash script that will run in the context of the layer created with the contents specified by <code>contents</code>.
  During the process to generate that layer, the script in <code>extraCommands</code> will be run first, if specified.
  After that, a {manpage}<code>fakeroot(1)</code> environment will be entered.
  The script specified in <code>fakeRootCommands</code> runs inside the fakeroot environment, and the layer is then generated from the view of the files inside the fakeroot environment.</p>
<p>This is useful to change the owners of the files in the layer (by running <code>chown</code>, for example), or performing any other privileged operations related to file manipulation (by default, all files in the layer will be owned by root, and the build environment doesn't have enough privileges to directly perform privileged operations on these files).</p>
<p>For more details, see the manpage for {manpage}<code>fakeroot(1)</code>.</p>
<p>:::{.caution}
  Due to how fakeroot works, static binaries cannot perform privileged file operations in <code>fakeRootCommands</code>, unless <code>enableFakechroot</code> is set to <code>true</code>.
  :::</p>
<p><em>Default value:</em> <code>""</code>.</p>
<p><code>enableFakechroot</code> (Boolean; <em>optional</em>)</p>
<p>: By default, the script specified in <code>fakeRootCommands</code> only runs inside a fakeroot environment.
  If <code>enableFakechroot</code> is <code>true</code>, a more complete chroot environment will be created using <a href="https://proot-me.github.io/"><code>proot</code></a> before running the script in <code>fakeRootCommands</code>.
  Files in the Nix store will be available.
  This allows scripts that perform installation in <code>/</code> to work as expected.
  This can be seen as an equivalent of <code>RUN ...</code> in a <code>Dockerfile</code>.</p>
<p><em>Default value:</em> <code>false</code></p>
<p><code>includeStorePaths</code> (Boolean; <em>optional</em>)</p>
<p>: The files specified in <code>contents</code> are put into layers in the generated image.
  If <code>includeStorePaths</code> is <code>false</code>, the actual files will not be included in the generated image, and only links to them will be added instead.
  It is <strong>not recommended</strong> to set this to <code>false</code> unless you have other tooling to insert the store paths via other means (such as bind mounting the host store) when running containers with the generated image.
  If you don't provide any extra tooling, the generated image won't run properly.</p>
<p>See <a href="#ex-dockerTools-streamLayeredImage-exploringlayers"></a> to understand the impact of setting <code>includeStorePaths</code> to <code>false</code>.</p>
<p><em>Default value:</em> <code>true</code></p>
<p><code>passthru</code> (Attribute Set; <em>optional</em>)</p>
<p>: Use this to pass any attributes as <a href="#var-stdenv-passthru">passthru</a> for the resulting derivation.</p>
<p><em>Default value:</em> <code>{}</code></p>
<h3 id="ssec-pkgs-dockerTools-streamLayeredImage-passthru-outputs">Passthru outputs<a class="headerlink" href="#ssec-pkgs-dockerTools-streamLayeredImage-passthru-outputs" title="Permanent link">#</a></h3>
<p><code>streamLayeredImage</code> also defines its own <a href="#var-stdenv-passthru"><code>passthru</code></a> attributes:</p>
<p><code>imageTag</code> (String)</p>
<p>: The tag of the generated image.
  This is useful if no tag was specified in the attributes of the argument to the function, because an automatic tag will be used instead.
  <code>imageTag</code> allows you to retrieve the value of the tag used in this case.</p>
<h3 id="ssec-pkgs-dockerTools-streamLayeredImage-examples">Examples<a class="headerlink" href="#ssec-pkgs-dockerTools-streamLayeredImage-examples" title="Permanent link">#</a></h3>
<p>:::{.example #ex-dockerTools-streamLayeredImage-hello}</p>
<h1 id="streaming-a-layered-docker-image">Streaming a layered Docker image<a class="headerlink" href="#streaming-a-layered-docker-image" title="Permanent link">#</a></h1>
<p>The following package builds a <strong>script</strong> which, when run, will stream a layered Docker image that runs the <code>hello</code> executable from the <code>hello</code> package.
The Docker image will have name <code>hello</code> and tag <code>latest</code>.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>dockerTools<span class="o">.</span>streamLayeredImage <span class="p">{</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>  <span class="ss">contents</span> <span class="o">=</span> <span class="p">[</span> hello <span class="p">];</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>  config<span class="o">.</span><span class="ss">Cmd</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin/hello&quot;</span> <span class="p">];</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>The result of building this package is a script.
Running this script and piping it into <code>docker load</code> gives you the same image that was built in <a href="#ex-dockerTools-buildLayeredImage-hello"></a>.
Note that in this case, the image is never added to the Nix store, but instead streamed directly into Docker.</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="o">(</span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>/nix/store/wsz2xl8ckxnlb769irvq6jv1280dfvxd-stream-hello
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>$<span class="w"> </span>/nix/store/wsz2xl8ckxnlb769irvq6jv1280dfvxd-stream-hello<span class="w"> </span><span class="p">|</span><span class="w"> </span>docker<span class="w"> </span>load
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>No<span class="w"> </span><span class="s1">&#39;fromImage&#39;</span><span class="w"> </span>provided
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>Creating<span class="w"> </span>layer<span class="w"> </span><span class="m">1</span><span class="w"> </span>from<span class="w"> </span>paths:<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/nix/store/i93s7xxblavsacpy82zdbn4kplsyq48l-libunistring-1.1&#39;</span><span class="o">]</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>Creating<span class="w"> </span>layer<span class="w"> </span><span class="m">2</span><span class="w"> </span>from<span class="w"> </span>paths:<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/nix/store/ji01n9vinnj22nbrb86nx8a1ssgpilx8-libidn2-2.3.4&#39;</span><span class="o">]</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>Creating<span class="w"> </span>layer<span class="w"> </span><span class="m">3</span><span class="w"> </span>from<span class="w"> </span>paths:<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/nix/store/ldrslljw4rg026nw06gyrdwl78k77vyq-xgcc-12.3.0-libgcc&#39;</span><span class="o">]</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>Creating<span class="w"> </span>layer<span class="w"> </span><span class="m">4</span><span class="w"> </span>from<span class="w"> </span>paths:<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/nix/store/9y8pmvk8gdwwznmkzxa6pwyah52xy3nk-glibc-2.38-27&#39;</span><span class="o">]</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>Creating<span class="w"> </span>layer<span class="w"> </span><span class="m">5</span><span class="w"> </span>from<span class="w"> </span>paths:<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1&#39;</span><span class="o">]</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>Creating<span class="w"> </span>layer<span class="w"> </span><span class="m">6</span><span class="w"> </span>with<span class="w"> </span>customisation...
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>Adding<span class="w"> </span>manifests...
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>Done.
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>Loaded<span class="w"> </span>image:<span class="w"> </span>hello:latest
</span></code></pre></div>
:::</p>
<p>:::{.example #ex-dockerTools-streamLayeredImage-exploringlayers}</p>
<h1 id="exploring-the-layers-in-an-image-built-with-streamlayeredimage">Exploring the layers in an image built with <code>streamLayeredImage</code><a class="headerlink" href="#exploring-the-layers-in-an-image-built-with-streamlayeredimage" title="Permanent link">#</a></h1>
<p>Assume the following package, which builds a layered Docker image with the <code>hello</code> package.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>dockerTools<span class="o">.</span>streamLayeredImage <span class="p">{</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>  <span class="ss">contents</span> <span class="o">=</span> <span class="p">[</span> hello <span class="p">];</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>The <code>hello</code> package depends on 4 other packages:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$<span class="w"> </span>nix-store<span class="w"> </span>--query<span class="w"> </span>-R<span class="w"> </span><span class="k">$(</span>nix-build<span class="w"> </span>-A<span class="w"> </span>hello<span class="k">)</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>/nix/store/i93s7xxblavsacpy82zdbn4kplsyq48l-libunistring-1.1
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>/nix/store/ji01n9vinnj22nbrb86nx8a1ssgpilx8-libidn2-2.3.4
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>/nix/store/ldrslljw4rg026nw06gyrdwl78k77vyq-xgcc-12.3.0-libgcc
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>/nix/store/9y8pmvk8gdwwznmkzxa6pwyah52xy3nk-glibc-2.38-27
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>/nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1
</span></code></pre></div>
<p>This means that all these packages will be included in the image generated by <code>streamLayeredImage</code>.
It will put each package in its own layer, for a total of 5 layers with actual files in them.
A final layer will be created only with symlinks for the <code>hello</code> package.</p>
<p>The image generated will have the following directory structure (some directories were collapsed for readability):</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>â”œâ”€â”€ bin
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>â”‚   â””â”€â”€ hello â†’ /nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1/bin/hello
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>â”œâ”€â”€ nix
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>â”‚   â””â”€â”€ store
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>â”‚       â”œâ”€âŠ• 9y8pmvk8gdwwznmkzxa6pwyah52xy3nk-glibc-2.38-27
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>â”‚       â”œâ”€âŠ• i93s7xxblavsacpy82zdbn4kplsyq48l-libunistring-1.1
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>â”‚       â”œâ”€âŠ• ji01n9vinnj22nbrb86nx8a1ssgpilx8-libidn2-2.3.4
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>â”‚       â”œâ”€âŠ• ldrslljw4rg026nw06gyrdwl78k77vyq-xgcc-12.3.0-libgcc
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>â”‚       â””â”€âŠ• zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>â””â”€â”€ share
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>    â”œâ”€â”€ info
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>    â”‚   â””â”€â”€ hello.info â†’ /nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1/share/info/hello.info
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>    â”œâ”€âŠ• locale
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    â””â”€â”€ man
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>        â””â”€â”€ man1
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>            â””â”€â”€ hello.1.gz â†’ /nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1/share/man/man1/hello.1.gz
</span></code></pre></div>
<p>Each of the packages in <code>/nix/store</code> comes from a layer in the image.
The final layer adds the <code>/bin</code> and <code>/share</code> directories, but they only contain links to the actual files in <code>/nix/store</code>.</p>
<p>If our package sets <code>includeStorePaths</code> to <code>false</code>, we'll end up with only the final layer with the links, but the actual files won't exist in the image:</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>dockerTools<span class="o">.</span>streamLayeredImage <span class="p">{</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>  <span class="ss">contents</span> <span class="o">=</span> <span class="p">[</span> hello <span class="p">];</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>  <span class="ss">includeStorePaths</span> <span class="o">=</span> <span class="no">false</span><span class="p">;</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>After building this package, the image will have the following directory structure:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>â”œâ”€â”€ bin
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>â”‚   â””â”€â”€ hello â†’ /nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1/bin/hello
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>â””â”€â”€ share
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    â”œâ”€â”€ info
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    â”‚   â””â”€â”€ hello.info â†’ /nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1/share/info/hello.info
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    â”œâ”€âŠ• locale
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    â””â”€â”€ man
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>        â””â”€â”€ man1
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>            â””â”€â”€ hello.1.gz â†’ /nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1/share/man/man1/hello.1.gz
</span></code></pre></div>
<p>Note how the links point to paths in <code>/nix/store</code>, but they're not included in the image itself.
This is why you need extra tooling when using <code>includeStorePaths</code>:
a container created from such image won't find any of the files it needs to run otherwise.
:::</p>
<p>::: {.example #ex-dockerTools-streamLayeredImage-configclosure}</p>
<h1 id="building-a-layered-docker-image-with-packages-directly-in-config">Building a layered Docker image with packages directly in <code>config</code><a class="headerlink" href="#building-a-layered-docker-image-with-packages-directly-in-config" title="Permanent link">#</a></h1>
<p>The closure of <code>config</code> is automatically included in the generated image.
The following package shows a more compact way to create the same output generated in <a href="#ex-dockerTools-streamLayeredImage-hello"></a>.</p>
<p><div class="language-nix highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello<span class="p">,</span> lib <span class="p">}:</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>dockerTools<span class="o">.</span>streamLayeredImage <span class="p">{</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>  config<span class="o">.</span><span class="ss">Cmd</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;</span><span class="si">${</span>lib<span class="o">.</span>getExe hello<span class="si">}</span><span class="s2">&quot;</span> <span class="p">];</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="p">}</span>
</span></code></pre></div>
:::</p>
<p>[]{#ssec-pkgs-dockerTools-fetchFromRegistry}</p>
<h2 id="ssec-pkgs-dockerTools-pullImage">pullImage<a class="headerlink" href="#ssec-pkgs-dockerTools-pullImage" title="Permanent link">#</a></h2>
<p>This function is similar to the <code>docker pull</code> command, which means it can be used to pull a Docker image from a registry that implements the <a href="https://distribution.github.io/distribution/spec/api/">Docker Registry HTTP API V2</a>.
By default, the <code>docker.io</code> registry is used.</p>
<p>The image will be downloaded as an uncompressed Docker-compatible repository tarball, which is suitable for use with other <code>dockerTools</code> functions such as <a href="#ssec-pkgs-dockerTools-buildImage"><code>buildImage</code></a>, <a href="#ssec-pkgs-dockerTools-buildLayeredImage"><code>buildLayeredImage</code></a>, and <a href="#ssec-pkgs-dockerTools-streamLayeredImage"><code>streamLayeredImage</code></a>.</p>
<p>This function requires two different types of hashes/digests to be specified:</p>
<ul>
<li>One of them is used to identify a unique image within the registry (see the documentation for the <code>imageDigest</code> attribute).</li>
<li>The other is used by Nix to ensure the contents of the output haven't changed (see the documentation for the <code>sha256</code> attribute).</li>
</ul>
<p>Both hashes are required because they must uniquely identify some content in two completely different systems (the Docker registry and the Nix store), but their values will not be the same.
See <a href="#ex-dockerTools-pullImage-nixprefetchdocker"></a> for a tool that can help gather these values.</p>
<h3 id="ssec-pkgs-dockerTools-pullImage-inputs">Inputs<a class="headerlink" href="#ssec-pkgs-dockerTools-pullImage-inputs" title="Permanent link">#</a></h3>
<p><code>pullImage</code> expects a single argument with the following attributes:</p>
<p><code>imageName</code> (String)</p>
<p>: Specifies the name of the image to be downloaded, as well as the registry endpoint.
  By default, the <code>docker.io</code> registry is used.
  To specify a different registry, prepend the endpoint to <code>imageName</code>, separated by a slash (<code>/</code>).
  See <a href="#ex-dockerTools-pullImage-differentregistry"></a> for how to do that.</p>
<p><code>imageDigest</code> (String)</p>
<p>: Specifies the digest of the image to be downloaded.</p>
<p>:::{.tip}
  <strong>Why can't I specify a tag to pull from, and have to use a digest instead?</strong></p>
<p>Tags are often updated to point to different image contents.
  The most common example is the <code>latest</code> tag, which is usually updated whenever a newer image version is available.</p>
<p>An image tag isn't enough to guarantee the contents of an image won't change, but a digest guarantees this.
  Providing a digest helps ensure that you will still be able to build the same Nix code and get the same output even if newer versions of an image are released.
  :::</p>
<p><code>sha256</code> (String)</p>
<p>: The hash of the image after it is downloaded.
  Internally, this is passed to the <a href="https://nixos.org/manual/nix/stable/language/advanced-attributes#adv-attr-outputHash"><code>outputHash</code></a> attribute of the resulting derivation.
  This is needed to provide a guarantee to Nix that the contents of the image haven't changed, because Nix doesn't support the value in <code>imageDigest</code>.</p>
<p><code>finalImageName</code> (String; <em>optional</em>)</p>
<p>: Specifies the name that will be used for the image after it has been downloaded.
  This only applies after the image is downloaded, and is not used to identify the image to be downloaded in the registry.
  Use <code>imageName</code> for that instead.</p>
<p><em>Default value:</em> the same value specified in <code>imageName</code>.</p>
<p><code>finalImageTag</code> (String; <em>optional</em>)</p>
<p>: Specifies the tag that will be used for the image after it has been downloaded.
  This only applies after the image is downloaded, and is not used to identify the image to be downloaded in the registry.</p>
<p><em>Default value:</em> <code>"latest"</code>.</p>
<p><code>os</code> (String; <em>optional</em>)</p>
<p>: Specifies the operating system of the image to pull.
  If specified, its value should follow the <a href="https://github.com/opencontainers/image-spec/blob/main/config.md#properties">OCI Image Configuration Specification</a>, which should still be compatible with Docker.
  According to the linked specification, all possible values for <code>$GOOS</code> in <a href="https://go.dev/doc/install/source#environment">the Go docs</a> should be valid, but will commonly be one of <code>darwin</code> or <code>linux</code>.</p>
<p><em>Default value:</em> <code>"linux"</code>.</p>
<p><code>arch</code> (String; <em>optional</em>)</p>
<p>: Specifies the architecture of the image to pull.
  If specified, its value should follow the <a href="https://github.com/opencontainers/image-spec/blob/main/config.md#properties">OCI Image Configuration Specification</a>, which should still be compatible with Docker.
  According to the linked specification, all possible values for <code>$GOARCH</code> in <a href="https://go.dev/doc/install/source#environment">the Go docs</a> should be valid, but will commonly be one of <code>386</code>, <code>amd64</code>, <code>arm</code>, or <code>arm64</code>.</p>
<p><em>Default value:</em> the same value from <code>pkgs.go.GOARCH</code>.</p>
<p><code>tlsVerify</code> (Boolean; <em>optional</em>)</p>
<p>: Used to enable or disable HTTPS and TLS certificate verification when communicating with the chosen Docker registry.
  Setting this to <code>false</code> will make <code>pullImage</code> connect to the registry through HTTP.</p>
<p><em>Default value:</em> <code>true</code>.</p>
<p><code>name</code> (String; <em>optional</em>)</p>
<p>: The name used for the output in the Nix store path.</p>
<p><em>Default value:</em> a value derived from <code>finalImageName</code> and <code>finalImageTag</code>, with some symbols replaced.
  It is recommended to treat the default as an opaque value.</p>
<h3 id="ssec-pkgs-dockerTools-pullImage-examples">Examples<a class="headerlink" href="#ssec-pkgs-dockerTools-pullImage-examples" title="Permanent link">#</a></h3>
<p>::: {.example #ex-dockerTools-pullImage-niximage}</p>
<h1 id="pulling-the-nixosnix-docker-image-from-the-default-registry">Pulling the nixos/nix Docker image from the default registry<a class="headerlink" href="#pulling-the-nixosnix-docker-image-from-the-default-registry" title="Permanent link">#</a></h1>
<p>This example pulls the <a href="https://hub.docker.com/r/nixos/nix"><code>nixos/nix</code> image</a> and saves it in the Nix store.</p>
<p><div class="language-nix highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="p">{</span> dockerTools <span class="p">}:</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>dockerTools<span class="o">.</span>pullImage <span class="p">{</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>  <span class="ss">imageName</span> <span class="o">=</span> <span class="s2">&quot;nixos/nix&quot;</span><span class="p">;</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>  <span class="ss">imageDigest</span> <span class="o">=</span> <span class="s2">&quot;sha256:b8ea88f763f33dfda2317b55eeda3b1a4006692ee29e60ee54ccf6d07348c598&quot;</span><span class="p">;</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>  <span class="ss">finalImageName</span> <span class="o">=</span> <span class="s2">&quot;nix&quot;</span><span class="p">;</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>  <span class="ss">finalImageTag</span> <span class="o">=</span> <span class="s2">&quot;2.19.3&quot;</span><span class="p">;</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>  <span class="ss">sha256</span> <span class="o">=</span> <span class="s2">&quot;zRwlQs1FiKrvHPaf8vWOR/Tlp1C5eLn1d9pE4BZg3oA=&quot;</span><span class="p">;</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="p">}</span>
</span></code></pre></div>
:::</p>
<p>::: {.example #ex-dockerTools-pullImage-differentregistry}</p>
<h1 id="pulling-the-nixosnix-docker-image-from-a-specific-registry">Pulling the nixos/nix Docker image from a specific registry<a class="headerlink" href="#pulling-the-nixosnix-docker-image-from-a-specific-registry" title="Permanent link">#</a></h1>
<p>This example pulls the <a href="https://quay.io/repository/coreos/etcd"><code>coreos/etcd</code> image</a> from the <code>quay.io</code> registry.</p>
<p><div class="language-nix highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="p">{</span> dockerTools <span class="p">}:</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>dockerTools<span class="o">.</span>pullImage <span class="p">{</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>  <span class="ss">imageName</span> <span class="o">=</span> <span class="s2">&quot;quay.io/coreos/etcd&quot;</span><span class="p">;</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>  <span class="ss">imageDigest</span> <span class="o">=</span> <span class="s2">&quot;sha256:24a23053f29266fb2731ebea27f915bb0fb2ae1ea87d42d890fe4e44f2e27c5d&quot;</span><span class="p">;</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>  <span class="ss">finalImageName</span> <span class="o">=</span> <span class="s2">&quot;etcd&quot;</span><span class="p">;</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>  <span class="ss">finalImageTag</span> <span class="o">=</span> <span class="s2">&quot;v3.5.11&quot;</span><span class="p">;</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>  <span class="ss">sha256</span> <span class="o">=</span> <span class="s2">&quot;Myw+85f2/EVRyMB3axECdmQ5eh9p1q77FWYKy8YpRWU=&quot;</span><span class="p">;</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="p">}</span>
</span></code></pre></div>
:::</p>
<p>::: {.example #ex-dockerTools-pullImage-nixprefetchdocker}</p>
<h1 id="finding-the-digest-and-hash-values-to-use-for-dockertoolspullimage">Finding the digest and hash values to use for <code>dockerTools.pullImage</code><a class="headerlink" href="#finding-the-digest-and-hash-values-to-use-for-dockertoolspullimage" title="Permanent link">#</a></h1>
<p>Since <a href="#ssec-pkgs-dockerTools-pullImage"><code>dockerTools.pullImage</code></a> requires two different hashes, one can run the <code>nix-prefetch-docker</code> tool to find out the values for the hashes.
The tool outputs some text for an attribute set which you can pass directly to <code>pullImage</code>.</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>$<span class="w"> </span>nix<span class="w"> </span>run<span class="w"> </span>nixpkgs#nix-prefetch-docker<span class="w"> </span>--<span class="w"> </span>--image-name<span class="w"> </span>nixos/nix<span class="w"> </span>--image-tag<span class="w"> </span><span class="m">2</span>.19.3<span class="w"> </span>--arch<span class="w"> </span>amd64<span class="w"> </span>--os<span class="w"> </span>linux
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>Writing<span class="w"> </span>manifest<span class="w"> </span>to<span class="w"> </span>image<span class="w"> </span>destination
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>-&gt;<span class="w"> </span>ImageName:<span class="w"> </span>nixos/nix
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>-&gt;<span class="w"> </span>ImageDigest:<span class="w"> </span>sha256:498fa2d7f2b5cb3891a4edf20f3a8f8496e70865099ba72540494cd3e2942634
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>-&gt;<span class="w"> </span>FinalImageName:<span class="w"> </span>nixos/nix
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>-&gt;<span class="w"> </span>FinalImageTag:<span class="w"> </span>latest
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>-&gt;<span class="w"> </span>ImagePath:<span class="w"> </span>/nix/store/4mxy9mn6978zkvlc670g5703nijsqc95-docker-image-nixos-nix-latest.tar
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>-&gt;<span class="w"> </span>ImageHash:<span class="w"> </span>1q6cf2pdrasa34zz0jw7pbs6lvv52rq2aibgxccbwcagwkg2qj1q
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="o">{</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">  </span><span class="nv">imageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nixos/nix&quot;</span><span class="p">;</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">  </span><span class="nv">imageDigest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sha256:498fa2d7f2b5cb3891a4edf20f3a8f8496e70865099ba72540494cd3e2942634&quot;</span><span class="p">;</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">  </span><span class="nv">sha256</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1q6cf2pdrasa34zz0jw7pbs6lvv52rq2aibgxccbwcagwkg2qj1q&quot;</span><span class="p">;</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">  </span><span class="nv">finalImageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nixos/nix&quot;</span><span class="p">;</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">  </span><span class="nv">finalImageTag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="o">}</span>
</span></code></pre></div>
<p>It is important to supply the <code>--arch</code> and <code>--os</code> arguments to <code>nix-prefetch-docker</code> to filter to a single image, in case there are multiple architectures and/or operating systems supported by the image name and tags specified.
By default, <code>nix-prefetch-docker</code> will set <code>os</code> to <code>linux</code> and <code>arch</code> to <code>amd64</code>.</p>
<p>Run <code>nix-prefetch-docker --help</code> for a list of all supported arguments:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>$<span class="w"> </span>nix<span class="w"> </span>run<span class="w"> </span>nixpkgs#nix-prefetch-docker<span class="w"> </span>--<span class="w"> </span>--help
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="o">(</span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span></code></pre></div>
:::</p>
<h2 id="ssec-pkgs-dockerTools-exportImage">exportImage<a class="headerlink" href="#ssec-pkgs-dockerTools-exportImage" title="Permanent link">#</a></h2>
<p>This function is similar to the <code>docker container export</code> command, which means it can be used to export an image's filesystem as an uncompressed tarball archive.
The difference is that <code>docker container export</code> is applied to containers, but <code>dockerTools.exportImage</code> applies to Docker images.
The resulting archive will not contain any image metadata (such as command to run with <code>docker container run</code>), only the filesystem contents.</p>
<p>You can use this function to import an archive in Docker with <code>docker image import</code>.
See <a href="#ex-dockerTools-exportImage-importingDocker"></a> to understand how to do that.</p>
<p>:::{.caution}
<code>exportImage</code> works by unpacking the given image inside a VM.
Because of this, using this function requires the <code>kvm</code> device to be available, see <a href="https://nixos.org/manual/nix/stable/command-ref/conf-file.html#conf-system-features"><code>system-features</code></a>.
:::</p>
<h3 id="ssec-pkgs-dockerTools-exportImage-inputs">Inputs<a class="headerlink" href="#ssec-pkgs-dockerTools-exportImage-inputs" title="Permanent link">#</a></h3>
<p><code>exportImage</code> expects an argument with the following attributes:</p>
<p><code>fromImage</code> (Attribute Set or String)</p>
<p>: The repository tarball of the image whose filesystem will be exported.
  It must be a valid Docker image, such as one exported by <code>docker image save</code>, or another image built with the <code>dockerTools</code> utility functions.</p>
<p>If <code>name</code> is not specified, <code>fromImage</code> must be an Attribute Set corresponding to a derivation, i.e. it can't be a path to a tarball.
  If <code>name</code> is specified, <code>fromImage</code> can be either an Attribute Set corresponding to a derivation or simply a path to a tarball.</p>
<p>See <a href="#ex-dockerTools-exportImage-naming"></a> and <a href="#ex-dockerTools-exportImage-fromImagePath"></a> to understand the connection between <code>fromImage</code>, <code>name</code>, and the name used for the output of <code>exportImage</code>.</p>
<p><code>fromImageName</code> (String or Null; <em>optional</em>)</p>
<p>: Used to specify the image within the repository tarball in case it contains multiple images.
  A value of <code>null</code> means that <code>exportImage</code> will use the first image available in the repository.</p>
<p>:::{.note}
  This must be used with <code>fromImageTag</code>. Using only <code>fromImageName</code> without <code>fromImageTag</code> will make <code>exportImage</code> use the first image available in the repository.
  :::</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>fromImageTag</code> (String or Null; <em>optional</em>)</p>
<p>: Used to specify the image within the repository tarball in case it contains multiple images.
  A value of <code>null</code> means that <code>exportImage</code> will use the first image available in the repository.</p>
<p>:::{.note}
  This must be used with <code>fromImageName</code>. Using only <code>fromImageTag</code> without <code>fromImageName</code> will make <code>exportImage</code> use the first image available in the repository
  :::</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>diskSize</code> (Number; <em>optional</em>)</p>
<p>: Controls the disk size (in megabytes) of the VM used to unpack the image.</p>
<p><em>Default value:</em> 1024.</p>
<p><code>name</code> (String; <em>optional</em>)</p>
<p>: The name used for the output in the Nix store path.</p>
<p><em>Default value:</em> the value of <code>fromImage.name</code>.</p>
<h3 id="ssec-pkgs-dockerTools-exportImage-examples">Examples<a class="headerlink" href="#ssec-pkgs-dockerTools-exportImage-examples" title="Permanent link">#</a></h3>
<p>:::{.example #ex-dockerTools-exportImage-hello}</p>
<h1 id="exporting-a-docker-image-with-dockertoolsexportimage">Exporting a Docker image with <code>dockerTools.exportImage</code><a class="headerlink" href="#exporting-a-docker-image-with-dockertoolsexportimage" title="Permanent link">#</a></h1>
<p>This example first builds a layered image with <a href="#ssec-pkgs-dockerTools-buildLayeredImage"><code>dockerTools.buildLayeredImage</code></a>, and then exports its filesystem with <code>dockerTools.exportImage</code>.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>dockerTools<span class="o">.</span>exportImage <span class="p">{</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>  <span class="ss">fromImage</span> <span class="o">=</span> dockerTools<span class="o">.</span>buildLayeredImage <span class="p">{</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>    <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>    <span class="ss">contents</span> <span class="o">=</span> <span class="p">[</span> hello <span class="p">];</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>  <span class="p">};</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>When building the package above, we can see the layers of the Docker image being unpacked to produce the final output:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>Unpacking<span class="w"> </span>base<span class="w"> </span>image...
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>From-image<span class="w"> </span>name<span class="w"> </span>or<span class="w"> </span>tag<span class="w"> </span>wasn<span class="s1">&#39;t set. Reading the first ID.</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="s1">Unpacking layer 5731199219418f175d1580dbca05677e69144425b2d9ecb60f416cd57ca3ca42/layer.tar</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="s1">tar: Removing leading `/&#39;</span><span class="w"> </span>from<span class="w"> </span>member<span class="w"> </span>names
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>Unpacking<span class="w"> </span>layer<span class="w"> </span>e2897bf34bb78c4a65736510204282d9f7ca258ba048c183d665bd0f3d24c5ec/layer.tar
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>tar:<span class="w"> </span>Removing<span class="w"> </span>leading<span class="w"> </span><span class="sb">`</span>/<span class="s1">&#39; from member names</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="s1">Unpacking layer 420aa5876dca4128cd5256da7dea0948e30ef5971712f82601718cdb0a6b4cda/layer.tar</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="s1">tar: Removing leading `/&#39;</span><span class="w"> </span>from<span class="w"> </span>member<span class="w"> </span>names
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>Unpacking<span class="w"> </span>layer<span class="w"> </span>ea5f4e620e7906c8ecbc506b5e6f46420e68d4b842c3303260d5eb621b5942e5/layer.tar
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>tar:<span class="w"> </span>Removing<span class="w"> </span>leading<span class="w"> </span><span class="sb">`</span>/<span class="s1">&#39; from member names</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="s1">Unpacking layer 65807b9abe8ab753fa97da8fb74a21fcd4725cc51e1b679c7973c97acd47ebcf/layer.tar</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="s1">tar: Removing leading `/&#39;</span><span class="w"> </span>from<span class="w"> </span>member<span class="w"> </span>names
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>Unpacking<span class="w"> </span>layer<span class="w"> </span>b7da2076b60ebc0ea6824ef641978332b8ac908d47b2d07ff31b9cc362245605/layer.tar
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>Executing<span class="w"> </span>post-mount<span class="w"> </span>steps...
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>Packing<span class="w"> </span>raw<span class="w"> </span>image...
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="o">[</span><span class="w">    </span><span class="m">1</span>.660036<span class="o">]</span><span class="w"> </span>reboot:<span class="w"> </span>Power<span class="w"> </span>down
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>/nix/store/x6a5m7c6zdpqz1d8j7cnzpx9glzzvd2h-hello
</span></code></pre></div>
<p>The following command lists some of the contents of the output to verify that the structure of the archive is as expected:</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>$<span class="w"> </span>tar<span class="w"> </span>--exclude<span class="w"> </span><span class="s1">&#39;*/share/*&#39;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s1">&#39;nix/store/*/*&#39;</span><span class="w"> </span>-tvf<span class="w"> </span>/nix/store/x6a5m7c6zdpqz1d8j7cnzpx9glzzvd2h-hello
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>drwxr-xr-x<span class="w"> </span>root/0<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="m">1979</span>-12-31<span class="w"> </span><span class="m">16</span>:00<span class="w"> </span>./
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>drwxr-xr-x<span class="w"> </span>root/0<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="m">1979</span>-12-31<span class="w"> </span><span class="m">16</span>:00<span class="w"> </span>./bin/
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>lrwxrwxrwx<span class="w"> </span>root/0<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="m">1979</span>-12-31<span class="w"> </span><span class="m">16</span>:00<span class="w"> </span>./bin/hello<span class="w"> </span>-&gt;<span class="w"> </span>/nix/store/h92a9jd0lhhniv2q417hpwszd4jhys7q-hello-2.12.1/bin/hello
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>dr-xr-xr-x<span class="w"> </span>root/0<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="m">1979</span>-12-31<span class="w"> </span><span class="m">16</span>:00<span class="w"> </span>./nix/
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>dr-xr-xr-x<span class="w"> </span>root/0<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="m">1979</span>-12-31<span class="w"> </span><span class="m">16</span>:00<span class="w"> </span>./nix/store/
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>dr-xr-xr-x<span class="w"> </span>root/0<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="m">1979</span>-12-31<span class="w"> </span><span class="m">16</span>:00<span class="w"> </span>./nix/store/05zbwhz8a7i2v79r9j21pl6m6cj0xi8k-libunistring-1.1/
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>dr-xr-xr-x<span class="w"> </span>root/0<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="m">1979</span>-12-31<span class="w"> </span><span class="m">16</span>:00<span class="w"> </span>./nix/store/ayg5rhjhi9ic73hqw33mjqjxwv59ndym-xgcc-13.2.0-libgcc/
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>dr-xr-xr-x<span class="w"> </span>root/0<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="m">1979</span>-12-31<span class="w"> </span><span class="m">16</span>:00<span class="w"> </span>./nix/store/h92a9jd0lhhniv2q417hpwszd4jhys7q-hello-2.12.1/
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>dr-xr-xr-x<span class="w"> </span>root/0<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="m">1979</span>-12-31<span class="w"> </span><span class="m">16</span>:00<span class="w"> </span>./nix/store/m59xdgkgnjbk8kk6k6vbxmqnf82mk9s0-libidn2-2.3.4/
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>dr-xr-xr-x<span class="w"> </span>root/0<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="m">1979</span>-12-31<span class="w"> </span><span class="m">16</span>:00<span class="w"> </span>./nix/store/p3jshbwxiwifm1py0yq544fmdyy98j8a-glibc-2.38-27/
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>drwxr-xr-x<span class="w"> </span>root/0<span class="w">            </span><span class="m">0</span><span class="w"> </span><span class="m">1979</span>-12-31<span class="w"> </span><span class="m">16</span>:00<span class="w"> </span>./share/
</span></code></pre></div>
:::</p>
<p>:::{.example #ex-dockerTools-exportImage-importingDocker}</p>
<h1 id="importing-an-archive-built-with-dockertoolsexportimage-in-docker">Importing an archive built with <code>dockerTools.exportImage</code> in Docker<a class="headerlink" href="#importing-an-archive-built-with-dockertoolsexportimage-in-docker" title="Permanent link">#</a></h1>
<p>We will use the same package from <a href="#ex-dockerTools-exportImage-hello"></a> and import it into Docker.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>dockerTools<span class="o">.</span>exportImage <span class="p">{</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>  <span class="ss">fromImage</span> <span class="o">=</span> dockerTools<span class="o">.</span>buildLayeredImage <span class="p">{</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>    <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>    <span class="ss">contents</span> <span class="o">=</span> <span class="p">[</span> hello <span class="p">];</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>  <span class="p">};</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>Building and importing it into Docker:</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="o">(</span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>/nix/store/x6a5m7c6zdpqz1d8j7cnzpx9glzzvd2h-hello
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>$<span class="w"> </span>docker<span class="w"> </span>image<span class="w"> </span>import<span class="w"> </span>/nix/store/x6a5m7c6zdpqz1d8j7cnzpx9glzzvd2h-hello
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>sha256:1d42dba415e9b298ea0decf6497fbce954de9b4fcb2984f91e307c8fedc1f52f
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>$<span class="w"> </span>docker<span class="w"> </span>image<span class="w"> </span>ls
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>REPOSITORY<span class="w">                              </span>TAG<span class="w">                </span>IMAGE<span class="w"> </span>ID<span class="w">       </span>CREATED<span class="w">         </span>SIZE
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>&lt;none&gt;<span class="w">                                  </span>&lt;none&gt;<span class="w">             </span>1d42dba415e9<span class="w">   </span><span class="m">4</span><span class="w"> </span>seconds<span class="w"> </span>ago<span class="w">   </span><span class="m">32</span>.6MB
</span></code></pre></div>
:::</p>
<p>:::{.example #ex-dockerTools-exportImage-naming}</p>
<h1 id="exploring-output-naming-with-dockertoolsexportimage">Exploring output naming with <code>dockerTools.exportImage</code><a class="headerlink" href="#exploring-output-naming-with-dockertoolsexportimage" title="Permanent link">#</a></h1>
<p><code>exportImage</code> does not require a <code>name</code> attribute if <code>fromImage</code> is a derivation, which means that the following works:</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>dockerTools<span class="o">.</span>exportImage <span class="p">{</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>  <span class="ss">fromImage</span> <span class="o">=</span> dockerTools<span class="o">.</span>buildLayeredImage <span class="p">{</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>    <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="ss">contents</span> <span class="o">=</span> <span class="p">[</span> hello <span class="p">];</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>  <span class="p">};</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>However, since <a href="#ssec-pkgs-dockerTools-buildLayeredImage"><code>dockerTools.buildLayeredImage</code></a>'s output ends with <code>.tar.gz</code>, the output of <code>exportImage</code> will also end with <code>.tar.gz</code>, even though the archive created with <code>exportImage</code> is uncompressed:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="o">(</span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>/nix/store/by3f40xvc4l6bkis74l0fj4zsy0djgkn-hello.tar.gz
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>$<span class="w"> </span>file<span class="w"> </span>/nix/store/by3f40xvc4l6bkis74l0fj4zsy0djgkn-hello.tar.gz
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>/nix/store/by3f40xvc4l6bkis74l0fj4zsy0djgkn-hello.tar.gz:<span class="w"> </span>POSIX<span class="w"> </span>tar<span class="w"> </span>archive<span class="w"> </span><span class="o">(</span>GNU<span class="o">)</span>
</span></code></pre></div>
<p>If the archive was actually compressed, the output of file would've mentioned that fact.
Because of this, it may be important to set a proper <code>name</code> attribute when using <code>exportImage</code> with other functions from <code>dockerTools</code>.
:::</p>
<p>:::{.example #ex-dockerTools-exportImage-fromImagePath}</p>
<h1 id="using-dockertoolsexportimage-with-a-path-as-fromimage">Using <code>dockerTools.exportImage</code> with a path as <code>fromImage</code><a class="headerlink" href="#using-dockertoolsexportimage-with-a-path-as-fromimage" title="Permanent link">#</a></h1>
<p>It is possible to use a path as the value of the <code>fromImage</code> attribute when calling <code>dockerTools.exportImage</code>.
However, when doing so, a <code>name</code> attribute <strong>MUST</strong> be specified, or you'll encounter an error when evaluating the Nix code.</p>
<p>For this example, we'll assume a Docker tarball image named <code>image.tar.gz</code> exists in the same directory where our package is defined:</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="p">{</span> dockerTools <span class="p">}:</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>dockerTools<span class="o">.</span>exportImage <span class="p">{</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;filesystem.tar&quot;</span><span class="p">;</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>  <span class="ss">fromImage</span> <span class="o">=</span> <span class="l">./image.tar.gz</span><span class="p">;</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>Building this will give us the expected output:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="o">(</span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>/nix/store/w13l8h3nlkg0zv56k7rj0ai0l2zlf7ss-filesystem.tar
</span></code></pre></div>
<p>If you don't specify a <code>name</code> attribute, you'll encounter an evaluation error and the package won't build.
:::</p>
<h2 id="ssec-pkgs-dockerTools-helpers">Environment Helpers<a class="headerlink" href="#ssec-pkgs-dockerTools-helpers" title="Permanent link">#</a></h2>
<p>When building Docker images with Nix, you might also want to add certain files that are expected to be available globally by the software you're packaging.
Simple examples are the <code>env</code> utility in <code>/usr/bin/env</code>, or trusted root TLS/SSL certificates.
Such files will most likely not be included if you're building a Docker image from scratch with Nix, and they might also not be included if you're starting from a Docker image that doesn't include them.
The helpers in this section are packages that provide some of these commonly-needed global files.</p>
<p>Most of these helpers are packages, which means you have to add them to the list of contents to be included in the image (this changes depending on the function you're using to build the image).
<a href="#ex-dockerTools-helpers-buildImage"></a> and <a href="#ex-dockerTools-helpers-buildLayeredImage"></a> show how to include these packages on <code>dockerTools</code> functions that build an image.
For more details on how that works, see the documentation for the function you're using.</p>
<h3 id="sssec-pkgs-dockerTools-helpers-usrBinEnv">usrBinEnv<a class="headerlink" href="#sssec-pkgs-dockerTools-helpers-usrBinEnv" title="Permanent link">#</a></h3>
<p>This provides the <code>env</code> utility at <code>/usr/bin/env</code>.
This is currently implemented by linking to the <code>env</code> binary from the <code>coreutils</code> package, but is considered an implementation detail that could change in the future.</p>
<h3 id="sssec-pkgs-dockerTools-helpers-binSh">binSh<a class="headerlink" href="#sssec-pkgs-dockerTools-helpers-binSh" title="Permanent link">#</a></h3>
<p>This provides a <code>/bin/sh</code> link to the <code>bash</code> binary from the <code>bashInteractive</code> package.
Because of this, it supports cases such as running a command interactively in a container (for example by running <code>docker run -it &lt;image_name&gt;</code>).</p>
<h3 id="sssec-pkgs-dockerTools-helpers-caCertificates">caCertificates<a class="headerlink" href="#sssec-pkgs-dockerTools-helpers-caCertificates" title="Permanent link">#</a></h3>
<p>This adds trusted root TLS/SSL certificates from the <code>cacert</code> package in multiple locations in an attempt to be compatible with binaries built for multiple Linux distributions.
The locations currently used are:</p>
<ul>
<li><code>/etc/ssl/certs/ca-bundle.crt</code></li>
<li><code>/etc/ssl/certs/ca-certificates.crt</code></li>
<li><code>/etc/pki/tls/certs/ca-bundle.crt</code></li>
</ul>
<p>[]{#ssec-pkgs-dockerTools-fakeNss}</p>
<h3 id="sssec-pkgs-dockerTools-helpers-fakeNss">fakeNss<a class="headerlink" href="#sssec-pkgs-dockerTools-helpers-fakeNss" title="Permanent link">#</a></h3>
<p>This is a re-export of the <code>fakeNss</code> package from Nixpkgs.
See <a href="#sec-fakeNss"></a>.</p>
<h3 id="ssec-pkgs-dockerTools-shadowSetup">shadowSetup<a class="headerlink" href="#ssec-pkgs-dockerTools-shadowSetup" title="Permanent link">#</a></h3>
<p>This is a string containing a script that sets up files needed for <a href="https://github.com/shadow-maint/shadow"><code>shadow</code></a> to work (using the <code>shadow</code> package from Nixpkgs), and alters <code>PATH</code> to make all its utilities available in the same script.
It is intended to be used with other dockerTools functions in attributes that expect scripts.
After the script in <code>shadowSetup</code> runs, you'll then be able to add more commands that make use of the utilities in <code>shadow</code>, such as adding any extra users and/or groups.
See <a href="#ex-dockerTools-shadowSetup-buildImage"></a> and <a href="#ex-dockerTools-shadowSetup-buildLayeredImage"></a> to better understand how to use it.</p>
<p><code>shadowSetup</code> achieves a result similar to <a href="#sssec-pkgs-dockerTools-helpers-fakeNss"><code>fakeNss</code></a>, but only sets up a <code>root</code> user with different values for the home directory and the shell to use, in addition to setting up files for <a href="https://en.wikipedia.org/wiki/Linux_PAM">PAM</a> and a {manpage}<code>login.defs(5)</code> file.</p>
<p>:::{.caution}
Using both <code>fakeNss</code> and <code>shadowSetup</code> at the same time will either cause your build to break or produce unexpected results.
Use either <code>fakeNss</code> or <code>shadowSetup</code> depending on your use case, but avoid using both.
:::</p>
<p>:::{.note}
When used with <a href="#ssec-pkgs-dockerTools-buildLayeredImage"><code>buildLayeredImage</code></a> or <a href="#ssec-pkgs-dockerTools-streamLayeredImage"><code>streamLayeredImage</code></a>, you will have to set the <code>enableFakechroot</code> attribute to <code>true</code>, or else the script in <code>shadowSetup</code> won't run properly.
See <a href="#ex-dockerTools-shadowSetup-buildLayeredImage"></a>.
:::</p>
<h3 id="ssec-pkgs-dockerTools-helpers-examples">Examples<a class="headerlink" href="#ssec-pkgs-dockerTools-helpers-examples" title="Permanent link">#</a></h3>
<p>:::{.example #ex-dockerTools-helpers-buildImage}</p>
<h1 id="using-dockertoolss-environment-helpers-with-buildimage">Using <code>dockerTools</code>'s environment helpers with <code>buildImage</code><a class="headerlink" href="#using-dockertoolss-environment-helpers-with-buildimage" title="Permanent link">#</a></h1>
<p>This example adds the <a href="#sssec-pkgs-dockerTools-helpers-binSh"><code>binSh</code></a> helper to a basic Docker image built with <a href="#ssec-pkgs-dockerTools-buildImage"><code>dockerTools.buildImage</code></a>.
This helper makes it possible to enter a shell inside the container.
This is the <code>buildImage</code> equivalent of <a href="#ex-dockerTools-helpers-buildLayeredImage"></a>.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>dockerTools<span class="o">.</span>buildImage <span class="p">{</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;env-helpers&quot;</span><span class="p">;</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>  <span class="ss">copyToRoot</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>    hello
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>    dockerTools<span class="o">.</span>binSh
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>  <span class="p">];</span>
</span></code></pre></div>
<p>After building the image and loading it in Docker, we can create a container based on it and enter a shell inside the container.
This is made possible by <code>binSh</code>.</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>/nix/store/2p0i3i04cgjlk71hsn7ll4kxaxxiv4qg-docker-image-env-helpers.tar.gz
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>$<span class="w"> </span>docker<span class="w"> </span>load<span class="w"> </span>-i<span class="w"> </span>/nix/store/2p0i3i04cgjlk71hsn7ll4kxaxxiv4qg-docker-image-env-helpers.tar.gz
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="o">(</span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-it<span class="w"> </span>env-helpers:latest<span class="w"> </span>/bin/sh
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>sh-5.2#<span class="w"> </span><span class="nb">help</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>GNU<span class="w"> </span>bash,<span class="w"> </span>version<span class="w"> </span><span class="m">5</span>.2.21<span class="o">(</span><span class="m">1</span><span class="o">)</span>-release<span class="w"> </span><span class="o">(</span>x86_64-pc-linux-gnu<span class="o">)</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="o">(</span>rest<span class="w"> </span>of<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span></code></pre></div>
:::</p>
<p>:::{.example #ex-dockerTools-helpers-buildLayeredImage}</p>
<h1 id="using-dockertoolss-environment-helpers-with-buildlayeredimage">Using <code>dockerTools</code>'s environment helpers with <code>buildLayeredImage</code><a class="headerlink" href="#using-dockertoolss-environment-helpers-with-buildlayeredimage" title="Permanent link">#</a></h1>
<p>This example adds the <a href="#sssec-pkgs-dockerTools-helpers-binSh"><code>binSh</code></a> helper to a basic Docker image built with <a href="#ssec-pkgs-dockerTools-buildLayeredImage"><code>dockerTools.buildLayeredImage</code></a>.
This helper makes it possible to enter a shell inside the container.
This is the <code>buildLayeredImage</code> equivalent of <a href="#ex-dockerTools-helpers-buildImage"></a>.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>dockerTools<span class="o">.</span>buildLayeredImage <span class="p">{</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;env-helpers&quot;</span><span class="p">;</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>  <span class="ss">contents</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>    hello
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>    dockerTools<span class="o">.</span>binSh
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>  <span class="p">];</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>  <span class="ss">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a>    <span class="ss">Cmd</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin/hello&quot;</span> <span class="p">];</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>  <span class="p">};</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>After building the image and loading it in Docker, we can create a container based on it and enter a shell inside the container.
This is made possible by <code>binSh</code>.</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>/nix/store/rpf47f4z5b9qr4db4ach9yr4b85hjhxq-env-helpers.tar.gz
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>$<span class="w"> </span>docker<span class="w"> </span>load<span class="w"> </span>-i<span class="w"> </span>/nix/store/rpf47f4z5b9qr4db4ach9yr4b85hjhxq-env-helpers.tar.gz
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="o">(</span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-it<span class="w"> </span>env-helpers:latest<span class="w"> </span>/bin/sh
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>sh-5.2#<span class="w"> </span><span class="nb">help</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>GNU<span class="w"> </span>bash,<span class="w"> </span>version<span class="w"> </span><span class="m">5</span>.2.21<span class="o">(</span><span class="m">1</span><span class="o">)</span>-release<span class="w"> </span><span class="o">(</span>x86_64-pc-linux-gnu<span class="o">)</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="o">(</span>rest<span class="w"> </span>of<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span></code></pre></div>
:::</p>
<p>:::{.example #ex-dockerTools-shadowSetup-buildImage}</p>
<h1 id="using-dockertoolsshadowsetup-with-dockertoolsbuildimage">Using <code>dockerTools.shadowSetup</code> with <code>dockerTools.buildImage</code><a class="headerlink" href="#using-dockertoolsshadowsetup-with-dockertoolsbuildimage" title="Permanent link">#</a></h1>
<p>This is an example that shows how to use <code>shadowSetup</code> with <code>dockerTools.buildImage</code>.
Note that the extra script in <code>runAsRoot</code> uses <code>groupadd</code> and <code>useradd</code>, which are binaries provided by the <code>shadow</code> package.
These binaries are added to the <code>PATH</code> by the <code>shadowSetup</code> script, but only for the duration of <code>runAsRoot</code>.</p>
<p><div class="language-nix highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>dockerTools<span class="o">.</span>buildImage <span class="p">{</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;shadow-basic&quot;</span><span class="p">;</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>  <span class="ss">copyToRoot</span> <span class="o">=</span> <span class="p">[</span> hello <span class="p">];</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>  <span class="ss">runAsRoot</span> <span class="o">=</span> <span class="s s-Multiline">&#39;&#39;</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="s s-Multiline">    </span><span class="si">${</span>dockerTools<span class="o">.</span>shadowSetup<span class="si">}</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="s s-Multiline">    groupadd -r hello</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="s s-Multiline">    useradd -r -g hello hello</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="s s-Multiline">    mkdir /data</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="s s-Multiline">    chown hello:hello /data</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="s s-Multiline">  &#39;&#39;</span><span class="p">;</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>  <span class="ss">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>    <span class="ss">Cmd</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin/hello&quot;</span> <span class="p">];</span>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>    <span class="ss">WorkingDir</span> <span class="o">=</span> <span class="s2">&quot;/data&quot;</span><span class="p">;</span>
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>  <span class="p">};</span>
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="p">}</span>
</span></code></pre></div>
:::</p>
<p>:::{.example #ex-dockerTools-shadowSetup-buildLayeredImage}</p>
<h1 id="using-dockertoolsshadowsetup-with-dockertoolsbuildlayeredimage">Using <code>dockerTools.shadowSetup</code> with <code>dockerTools.buildLayeredImage</code><a class="headerlink" href="#using-dockertoolsshadowsetup-with-dockertoolsbuildlayeredimage" title="Permanent link">#</a></h1>
<p>It accomplishes the same thing as <a href="#ex-dockerTools-shadowSetup-buildImage"></a>, but using <code>buildLayeredImage</code> instead.</p>
<p>Note that the extra script in <code>fakeRootCommands</code> uses <code>groupadd</code> and <code>useradd</code>, which are binaries provided by the <code>shadow</code> package.
These binaries are added to the <code>PATH</code> by the <code>shadowSetup</code> script, but only for the duration of <code>fakeRootCommands</code>.</p>
<p><div class="language-nix highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>dockerTools<span class="o">.</span>buildLayeredImage <span class="p">{</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;shadow-basic&quot;</span><span class="p">;</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>  <span class="ss">contents</span> <span class="o">=</span> <span class="p">[</span> hello <span class="p">];</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>  <span class="ss">fakeRootCommands</span> <span class="o">=</span> <span class="s s-Multiline">&#39;&#39;</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="s s-Multiline">    </span><span class="si">${</span>dockerTools<span class="o">.</span>shadowSetup<span class="si">}</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="s s-Multiline">    groupadd -r hello</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="s s-Multiline">    useradd -r -g hello hello</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="s s-Multiline">    mkdir /data</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="s s-Multiline">    chown hello:hello /data</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="s s-Multiline">  &#39;&#39;</span><span class="p">;</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>  <span class="ss">enableFakechroot</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>  <span class="ss">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>    <span class="ss">Cmd</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;/bin/hello&quot;</span> <span class="p">];</span>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a>    <span class="ss">WorkingDir</span> <span class="o">=</span> <span class="s2">&quot;/data&quot;</span><span class="p">;</span>
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a>  <span class="p">};</span>
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a><span class="p">}</span>
</span></code></pre></div>
:::</p>
<p>[]{#ssec-pkgs-dockerTools-buildNixShellImage-arguments}</p>
<h2 id="ssec-pkgs-dockerTools-buildNixShellImage">buildNixShellImage<a class="headerlink" href="#ssec-pkgs-dockerTools-buildNixShellImage" title="Permanent link">#</a></h2>
<p><code>buildNixShellImage</code> uses <a href="#ssec-pkgs-dockerTools-streamNixShellImage"><code>streamNixShellImage</code></a> underneath to build a compressed Docker-compatible repository tarball of an image that sets up an environment similar to that of running <code>nix-shell</code> on a derivation.
Basically, <code>buildNixShellImage</code> runs the script created by <code>streamNixShellImage</code> to save the compressed image in the Nix store.</p>
<p><code>buildNixShellImage</code> supports the same options as <code>streamNixShellImage</code>, see <a href="#ssec-pkgs-dockerTools-streamNixShellImage"><code>streamNixShellImage</code></a> for details.</p>
<p>[]{#ssec-pkgs-dockerTools-buildNixShellImage-example}</p>
<h3 id="ssec-pkgs-dockerTools-buildNixShellImage-examples">Examples<a class="headerlink" href="#ssec-pkgs-dockerTools-buildNixShellImage-examples" title="Permanent link">#</a></h3>
<p>:::{.example #ex-dockerTools-buildNixShellImage-hello}</p>
<h1 id="building-a-docker-image-with-buildnixshellimage-with-the-build-environment-for-the-hello-package">Building a Docker image with <code>buildNixShellImage</code> with the build environment for the <code>hello</code> package<a class="headerlink" href="#building-a-docker-image-with-buildnixshellimage-with-the-build-environment-for-the-hello-package" title="Permanent link">#</a></h1>
<p>This example shows how to build the <code>hello</code> package inside a Docker container built with <code>buildNixShellImage</code>.
The Docker image generated will have a name like <code>hello-&lt;version&gt;-env</code> and tag <code>latest</code>.
This example is the <code>buildNixShellImage</code> equivalent of <a href="#ex-dockerTools-streamNixShellImage-hello"></a>.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>dockerTools<span class="o">.</span>buildNixShellImage <span class="p">{</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>  <span class="ss">drv</span> <span class="o">=</span> hello<span class="p">;</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>The result of building this package is a <code>.tar.gz</code> file that can be loaded into Docker:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>/nix/store/pkj1sgzaz31wl0pbvbg3yp5b3kxndqms-hello-2.12.1-env.tar.gz
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>$<span class="w"> </span>docker<span class="w"> </span>load<span class="w"> </span>-i<span class="w"> </span>/nix/store/pkj1sgzaz31wl0pbvbg3yp5b3kxndqms-hello-2.12.1-env.tar.gz
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>Loaded<span class="w"> </span>image:<span class="w"> </span>hello-2.12.1-env:latest
</span></code></pre></div>
<p>After starting an interactive container, the derivation can be built by running <code>buildDerivation</code>, and the output can be executed as expected:</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>hello-2.12.1-env:latest
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="o">[</span>nix-shell:~<span class="o">]</span>$<span class="w"> </span>buildDerivation
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>Running<span class="w"> </span>phase:<span class="w"> </span>unpackPhase
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>unpacking<span class="w"> </span><span class="nb">source</span><span class="w"> </span>archive<span class="w"> </span>/nix/store/pa10z4ngm0g83kx9mssrqzz30s84vq7k-hello-2.12.1.tar.gz
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="nb">source</span><span class="w"> </span>root<span class="w"> </span>is<span class="w"> </span>hello-2.12.1
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>Running<span class="w"> </span>phase:<span class="w"> </span>fixupPhase
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>shrinking<span class="w"> </span>RPATHs<span class="w"> </span>of<span class="w"> </span>ELF<span class="w"> </span>executables<span class="w"> </span>and<span class="w"> </span>libraries<span class="w"> </span><span class="k">in</span><span class="w"> </span>/nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>shrinking<span class="w"> </span>/nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1/bin/hello
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>checking<span class="w"> </span><span class="k">for</span><span class="w"> </span>references<span class="w"> </span>to<span class="w"> </span>/build/<span class="w"> </span><span class="k">in</span><span class="w"> </span>/nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1...
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>gzipping<span class="w"> </span>man<span class="w"> </span>pages<span class="w"> </span>under<span class="w"> </span>/nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1/share/man/
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a>patching<span class="w"> </span>script<span class="w"> </span>interpreter<span class="w"> </span>paths<span class="w"> </span><span class="k">in</span><span class="w"> </span>/nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>stripping<span class="w"> </span><span class="o">(</span>with<span class="w"> </span><span class="nb">command</span><span class="w"> </span>strip<span class="w"> </span>and<span class="w"> </span>flags<span class="w"> </span>-S<span class="w"> </span>-p<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w">  </span>/nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1/bin
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="o">[</span>nix-shell:~<span class="o">]</span>$<span class="w"> </span><span class="nv">$out</span>/bin/hello
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a>Hello,<span class="w"> </span>world!
</span></code></pre></div>
:::</p>
<h2 id="ssec-pkgs-dockerTools-streamNixShellImage">streamNixShellImage<a class="headerlink" href="#ssec-pkgs-dockerTools-streamNixShellImage" title="Permanent link">#</a></h2>
<p><code>streamNixShellImage</code> builds a <strong>script</strong> which, when run, will stream to stdout a Docker-compatible repository tarball of an image that sets up an environment similar to that of running <code>nix-shell</code> on a derivation.
This means that <code>streamNixShellImage</code> does not output an image into the Nix store, but only a script that builds the image, saving on IO and disk/cache space, particularly with large images.
See <a href="#ex-dockerTools-streamNixShellImage-hello"></a> to understand how to load in Docker the image generated by this script.</p>
<p>The environment set up by <code>streamNixShellImage</code> somewhat resembles the Nix sandbox typically used by <code>nix-build</code>, with a major difference being that access to the internet is allowed.
It also behaves like an interactive <code>nix-shell</code>, running things like <code>shellHook</code> (see <a href="#ex-dockerTools-streamNixShellImage-addingShellHook"></a>) and setting an interactive prompt.
If the derivation is buildable (i.e. <code>nix-build</code> can be used on it), running <code>buildDerivation</code> in the container will build the derivation, with all its outputs being available in the correct <code>/nix/store</code> paths, pointed to by the respective environment variables (e.g. <code>$out</code>).</p>
<p>::: {.caution}
The environment in the image doesn't match <code>nix-shell</code> or <code>nix-build</code> exactly, and this function is known not to work correctly for fixed-output derivations, content-addressed derivations, impure derivations and other special types of derivations.
:::</p>
<h3 id="ssec-pkgs-dockerTools-streamNixShellImage-inputs">Inputs<a class="headerlink" href="#ssec-pkgs-dockerTools-streamNixShellImage-inputs" title="Permanent link">#</a></h3>
<p><code>streamNixShellImage</code> expects one argument with the following attributes:</p>
<p><code>drv</code> (Attribute Set)</p>
<p>: The derivation for which the environment in the image will be set up.
  Adding packages to the Docker image is possible by extending the list of <code>nativeBuildInputs</code> of this derivation.
  See <a href="#ex-dockerTools-streamNixShellImage-extendingBuildInputs"></a> for how to do that.
  Similarly, you can extend the image initialization script by extending <code>shellHook</code>.
  <a href="#ex-dockerTools-streamNixShellImage-addingShellHook"></a> shows how to do that.</p>
<p><code>name</code> (String; <em>optional</em>)</p>
<p>: The name of the generated image.</p>
<p><em>Default value:</em> the value of <code>drv.name + "-env"</code>.</p>
<p><code>tag</code> (String or Null; <em>optional</em>)</p>
<p>: Tag of the generated image.
  If <code>null</code>, the hash of the nix derivation that builds the Docker image will be used as the tag.</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>uid</code> (Number; <em>optional</em>)</p>
<p>: The user ID to run the container as.
  This can be seen as a <code>nixbld</code> build user.</p>
<p><em>Default value:</em> 1000.</p>
<p><code>gid</code> (Number; <em>optional</em>)</p>
<p>: The group ID to run the container as.
  This can be seen as a <code>nixbld</code> build group.</p>
<p><em>Default value:</em> 1000.</p>
<p><code>homeDirectory</code> (String; <em>optional</em>)</p>
<p>: The home directory of the user the container is running as.</p>
<p><em>Default value:</em> <code>/build</code>.</p>
<p><code>shell</code> (String; <em>optional</em>)</p>
<p>: The path to the <code>bash</code> binary to use as the shell.
  This shell is started when running the image.
  This can be seen as an equivalent of the <code>NIX_BUILD_SHELL</code> <a href="https://nixos.org/manual/nix/stable/command-ref/nix-shell.html#environment-variables">environment variable</a> for {manpage}<code>nix-shell(1)</code>.</p>
<p><em>Default value:</em> the <code>bash</code> binary from the <code>bashInteractive</code> package.</p>
<p><code>command</code> (String or Null; <em>optional</em>)</p>
<p>: If specified, this command will be run in the environment of the derivation in an interactive shell.
  A call to <code>exit</code> will be added after the command if it is specified, so the shell will exit after it's finished running.
  This can be seen as an equivalent of the <code>--command</code> option in {manpage}<code>nix-shell(1)</code>.</p>
<p><em>Default value:</em> <code>null</code>.</p>
<p><code>run</code> (String or Null; <em>optional</em>)</p>
<p>: Similar to the <code>command</code> attribute, but runs the command in a non-interactive shell instead.
  A call to <code>exit</code> will be added after the command if it is specified, so the shell will exit after it's finished running.
  This can be seen as an equivalent of the <code>--run</code> option in {manpage}<code>nix-shell(1)</code>.</p>
<p><em>Default value:</em> <code>null</code>.</p>
<h3 id="ssec-pkgs-dockerTools-streamNixShellImage-examples">Examples<a class="headerlink" href="#ssec-pkgs-dockerTools-streamNixShellImage-examples" title="Permanent link">#</a></h3>
<p>:::{.example #ex-dockerTools-streamNixShellImage-hello}</p>
<h1 id="building-a-docker-image-with-streamnixshellimage-with-the-build-environment-for-the-hello-package">Building a Docker image with <code>streamNixShellImage</code> with the build environment for the <code>hello</code> package<a class="headerlink" href="#building-a-docker-image-with-streamnixshellimage-with-the-build-environment-for-the-hello-package" title="Permanent link">#</a></h1>
<p>This example shows how to build the <code>hello</code> package inside a Docker container built with <code>streamNixShellImage</code>.
The Docker image generated will have a name like <code>hello-&lt;version&gt;-env</code> and tag <code>latest</code>.
This example is the <code>streamNixShellImage</code> equivalent of <a href="#ex-dockerTools-buildNixShellImage-hello"></a>.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>dockerTools<span class="o">.</span>streamNixShellImage <span class="p">{</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>  <span class="ss">drv</span> <span class="o">=</span> hello<span class="p">;</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>The result of building this package is a script.
Running this script and piping it into <code>docker load</code> gives you the same image that was built in <a href="#ex-dockerTools-buildNixShellImage-hello"></a>.</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>/nix/store/8vhznpz2frqazxnd8pgdvf38jscdypax-stream-hello-2.12.1-env
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>$<span class="w"> </span>/nix/store/8vhznpz2frqazxnd8pgdvf38jscdypax-stream-hello-2.12.1-env<span class="w"> </span><span class="p">|</span><span class="w"> </span>docker<span class="w"> </span>load
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>Loaded<span class="w"> </span>image:<span class="w"> </span>hello-2.12.1-env:latest
</span></code></pre></div>
<p>After starting an interactive container, the derivation can be built by running <code>buildDerivation</code>, and the output can be executed as expected:</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>hello-2.12.1-env:latest
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="o">[</span>nix-shell:~<span class="o">]</span>$<span class="w"> </span>buildDerivation
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>Running<span class="w"> </span>phase:<span class="w"> </span>unpackPhase
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>unpacking<span class="w"> </span><span class="nb">source</span><span class="w"> </span>archive<span class="w"> </span>/nix/store/pa10z4ngm0g83kx9mssrqzz30s84vq7k-hello-2.12.1.tar.gz
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="nb">source</span><span class="w"> </span>root<span class="w"> </span>is<span class="w"> </span>hello-2.12.1
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>Running<span class="w"> </span>phase:<span class="w"> </span>fixupPhase
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>shrinking<span class="w"> </span>RPATHs<span class="w"> </span>of<span class="w"> </span>ELF<span class="w"> </span>executables<span class="w"> </span>and<span class="w"> </span>libraries<span class="w"> </span><span class="k">in</span><span class="w"> </span>/nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>shrinking<span class="w"> </span>/nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1/bin/hello
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>checking<span class="w"> </span><span class="k">for</span><span class="w"> </span>references<span class="w"> </span>to<span class="w"> </span>/build/<span class="w"> </span><span class="k">in</span><span class="w"> </span>/nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1...
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>gzipping<span class="w"> </span>man<span class="w"> </span>pages<span class="w"> </span>under<span class="w"> </span>/nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1/share/man/
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a>patching<span class="w"> </span>script<span class="w"> </span>interpreter<span class="w"> </span>paths<span class="w"> </span><span class="k">in</span><span class="w"> </span>/nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a>stripping<span class="w"> </span><span class="o">(</span>with<span class="w"> </span><span class="nb">command</span><span class="w"> </span>strip<span class="w"> </span>and<span class="w"> </span>flags<span class="w"> </span>-S<span class="w"> </span>-p<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w">  </span>/nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1/bin
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="o">[</span>nix-shell:~<span class="o">]</span>$<span class="w"> </span><span class="nv">$out</span>/bin/hello
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a>Hello,<span class="w"> </span>world!
</span></code></pre></div>
:::</p>
<p>:::{.example #ex-dockerTools-streamNixShellImage-extendingBuildInputs}</p>
<h1 id="adding-extra-packages-to-a-docker-image-built-with-streamnixshellimage">Adding extra packages to a Docker image built with <code>streamNixShellImage</code><a class="headerlink" href="#adding-extra-packages-to-a-docker-image-built-with-streamnixshellimage" title="Permanent link">#</a></h1>
<p>This example shows how to add extra packages to an image built with <code>streamNixShellImage</code>.
In this case, we'll add the <code>cowsay</code> package.
The Docker image generated will have a name like <code>hello-&lt;version&gt;-env</code> and tag <code>latest</code>.
This example uses <a href="#ex-dockerTools-streamNixShellImage-hello"></a> as a starting point.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> cowsay<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>dockerTools<span class="o">.</span>streamNixShellImage <span class="p">{</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>  <span class="ss">drv</span> <span class="o">=</span> hello<span class="o">.</span>overrideAttrs <span class="p">(</span>old<span class="p">:</span> <span class="p">{</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>    <span class="ss">nativeBuildInputs</span> <span class="o">=</span> old<span class="o">.</span>nativeBuildInputs <span class="ow">or</span> <span class="p">[]</span> <span class="o">++</span> <span class="p">[</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>      cowsay
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>    <span class="p">];</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>  <span class="p">});</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>The result of building this package is a script which can be run and piped into <code>docker load</code> to load the generated image.</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>/nix/store/h5abh0vljgzg381lna922gqknx6yc0v7-stream-hello-2.12.1-env
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>$<span class="w"> </span>/nix/store/h5abh0vljgzg381lna922gqknx6yc0v7-stream-hello-2.12.1-env<span class="w"> </span><span class="p">|</span><span class="w"> </span>docker<span class="w"> </span>load
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>Loaded<span class="w"> </span>image:<span class="w"> </span>hello-2.12.1-env:latest
</span></code></pre></div>
<p>After starting an interactive container, we can verify the extra package is available by running <code>cowsay</code>:</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>hello-2.12.1-env:latest
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="o">[</span>nix-shell:~<span class="o">]</span>$<span class="w"> </span>cowsay<span class="w"> </span><span class="s2">&quot;Hello, world!&quot;</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w"> </span>_______________
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>&lt;<span class="w"> </span>Hello,<span class="w"> </span>world!<span class="w"> </span>&gt;
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w"> </span>---------------
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">        </span><span class="se">\ </span><span class="w">  </span>^__^
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="w">         </span><span class="se">\ </span><span class="w"> </span><span class="o">(</span>oo<span class="o">)</span><span class="se">\_</span>______
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">            </span><span class="o">(</span>__<span class="o">)</span><span class="se">\ </span><span class="w">      </span><span class="o">)</span><span class="se">\/\</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">                </span><span class="o">||</span>----w<span class="w"> </span><span class="p">|</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="w">                </span><span class="o">||</span><span class="w">     </span><span class="o">||</span>
</span></code></pre></div>
:::</p>
<p>:::{.example #ex-dockerTools-streamNixShellImage-addingShellHook}</p>
<h1 id="adding-a-shellhook-to-a-docker-image-built-with-streamnixshellimage">Adding a <code>shellHook</code> to a Docker image built with <code>streamNixShellImage</code><a class="headerlink" href="#adding-a-shellhook-to-a-docker-image-built-with-streamnixshellimage" title="Permanent link">#</a></h1>
<p>This example shows how to add a <code>shellHook</code> command to an image built with <code>streamNixShellImage</code>.
In this case, we'll simply output the string <code>Hello, world!</code>.
The Docker image generated will have a name like <code>hello-&lt;version&gt;-env</code> and tag <code>latest</code>.
This example uses <a href="#ex-dockerTools-streamNixShellImage-hello"></a> as a starting point.</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="p">{</span> dockerTools<span class="p">,</span> hello <span class="p">}:</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>dockerTools<span class="o">.</span>streamNixShellImage <span class="p">{</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>  <span class="ss">tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>  <span class="ss">drv</span> <span class="o">=</span> hello<span class="o">.</span>overrideAttrs <span class="p">(</span>old<span class="p">:</span> <span class="p">{</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>    <span class="ss">shellHook</span> <span class="o">=</span> <span class="s s-Multiline">&#39;&#39;</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="s s-Multiline">      </span><span class="si">${</span>old<span class="o">.</span>shellHook <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="si">}</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="s s-Multiline">      echo &quot;Hello, world!&quot;</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="s s-Multiline">    &#39;&#39;</span><span class="p">;</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>  <span class="p">});</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>The result of building this package is a script which can be run and piped into <code>docker load</code> to load the generated image.</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>$<span class="w"> </span>nix-build
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>/nix/store/iz4dhdvgzazl5vrgyz719iwjzjy6xlx1-stream-hello-2.12.1-env
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>$<span class="w"> </span>/nix/store/iz4dhdvgzazl5vrgyz719iwjzjy6xlx1-stream-hello-2.12.1-env<span class="w"> </span><span class="p">|</span><span class="w"> </span>docker<span class="w"> </span>load
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="o">(</span>some<span class="w"> </span>output<span class="w"> </span>removed<span class="w"> </span><span class="k">for</span><span class="w"> </span>clarity<span class="o">)</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>Loaded<span class="w"> </span>image:<span class="w"> </span>hello-2.12.1-env:latest
</span></code></pre></div>
<p>After starting an interactive container, we can see the result of the <code>shellHook</code>:</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>hello-2.12.1-env:latest
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>Hello,<span class="w"> </span>world!
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="o">[</span>nix-shell:~<span class="o">]</span>$
</span></code></pre></div>
:::</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="binarycache.section.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: pkgs.mkBinaryCache">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                pkgs.mkBinaryCache
              </div>
            </div>
          </a>
        
        
          
          <a href="makediskimage.section.html" class="md-footer__link md-footer__link--next" aria-label="Next: &amp;lt;nixpkgs/nixos/lib/make-disk-image.nix&amp;gt;">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                &lt;nixpkgs/nixos/lib/make-disk-image.nix&gt;
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 <a href=https://nervosys.ai/>Nervosys, LLC</a>
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/nervosys/Botnix" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://discord.gg/x84JXYje" target="_blank" rel="noopener" title="discord.gg" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485.065 485.065 0 0 0 404.081 32.03a1.816 1.816 0 0 0-1.923.91 337.461 337.461 0 0 0-14.9 30.6 447.848 447.848 0 0 0-134.426 0 309.541 309.541 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.689 483.689 0 0 0-119.688 37.107 1.712 1.712 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.016 2.016 0 0 0 .765 1.375 487.666 487.666 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348.2 348.2 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321.173 321.173 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251.047 251.047 0 0 0 9.109-7.137 1.819 1.819 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.812 1.812 0 0 1 1.924.233 234.533 234.533 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.407 301.407 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391.055 391.055 0 0 0 30.014 48.815 1.864 1.864 0 0 0 2.063.7A486.048 486.048 0 0 0 610.7 405.729a1.882 1.882 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541ZM222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241Zm195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241Z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://x.com/nervosys" target="_blank" rel="noopener" title="x.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9L389.2 48zm-24.8 373.8h39.1L151.1 88h-42l255.3 333.8z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.tabs.link", "navigation.top", "navigation.path", "navigation.footer", "search.suggest", "search.share", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.caa56a14.min.js"></script>
      
        <script src="../../javascripts/extra.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>